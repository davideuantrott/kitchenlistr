<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitchenListr - Meal Planner</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Plan your meals, build your shopping list automatically">
    <meta name="theme-color" content="#4FB286">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="KitchenListr">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='96' fill='%234FB286'/><text x='256' y='340' font-size='280' text-anchor='middle' fill='white'>üçΩ</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Coolors palette: 50FFB1-4FB286-3C896D-546D64-4D685A */
            --bg-cream: #F4F9F7;
            --bg-white: #FFFFFF;
            --text-primary: #2A3B35;
            --text-secondary: #546D64;
            --accent-green: #4FB286;
            --accent-green-light: #D9F5E8;
            --accent-green-dark: #3C896D;
            --accent-mint: #50FFB1;
            --accent-sage: #4D685A;
            --border-light: #D1E0DA;
            --border-medium: #4D685A;
            --shadow-sm: 0 1px 3px rgba(60, 137, 109, 0.1);
            --shadow-md: 0 4px 12px rgba(60, 137, 109, 0.15);
            --shadow-lg: 0 8px 24px rgba(60, 137, 109, 0.18);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-cream);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            font-family: 'Fraunces', Georgia, serif;
            font-weight: 600;
            line-height: 1.3;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-cream);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-light);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Auth Screen */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-screen.hidden {
            display: none;
        }

        .auth-container {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo-text {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .logo-highlight {
            color: var(--accent-green);
        }

        .auth-title {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .auth-error {
            background: #FEE2E2;
            color: #DC2626;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .auth-error.visible {
            display: block;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            background: var(--bg-cream);
            border-radius: var(--radius-sm);
            padding: 0.25rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.6rem;
            border: none;
            background: transparent;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            background: var(--bg-white);
            color: var(--accent-green);
            box-shadow: var(--shadow-sm);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-light);
        }

        .auth-divider span {
            padding: 0 1rem;
        }

        .google-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            background: var(--bg-white);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .google-btn:hover {
            background: var(--bg-cream);
            border-color: var(--text-secondary);
        }

        .google-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-white);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .sync-status.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        .sync-dot.syncing {
            animation: pulse 1s infinite;
        }

        .sync-dot.error {
            background: #DC3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* App Container */
        .app-container {
            display: none;
        }

        .app-container.visible {
            display: block;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }

        .logo-text {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .logo:hover {
            opacity: 0.85;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-green-light);
            color: var(--accent-green-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .sign-out-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            background: var(--bg-white);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sign-out-btn:hover {
            background: var(--bg-cream);
            color: var(--text-primary);
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-cream);
            padding: 0.25rem;
            border-radius: var(--radius-md);
        }

        .nav-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            color: var(--text-primary);
            background: var(--bg-white);
        }

        .nav-btn.active {
            background: var(--bg-white);
            color: var(--accent-green);
            box-shadow: var(--shadow-sm);
            border-bottom: 2px solid var(--accent-mint);
        }

        /* Main Content */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Page Headers */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.75rem;
            color: var(--text-primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.25rem;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-green-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 178, 134, 0.3);
        }

        .btn-primary:disabled {
            background: var(--border-light);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--bg-cream);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background: #DC3545;
            color: white;
        }

        .btn-danger:hover {
            background: #C82333;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* Cards */
        .card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(to bottom, var(--bg-white), var(--bg-cream));
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Recipe Grid */
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
        }

        .recipe-card {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .recipe-card:hover {
            border-color: var(--accent-mint);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .recipe-card-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .recipe-card-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .recipe-card-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--accent-green-light);
            color: var(--accent-green-dark);
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--bg-white);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px var(--accent-green-light);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.35rem;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-green);
        }

        /* Ingredient Mode Toggle */
        .ingredients-toggle {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            background: var(--bg-cream);
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            width: fit-content;
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .toggle-btn:hover {
            color: var(--text-primary);
        }

        .toggle-btn.active {
            background: var(--bg-white);
            color: var(--accent-green);
            box-shadow: var(--shadow-sm);
        }

        /* Ingredients List */
        .ingredients-list {
            list-style: none;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .ingredient-qty-input {
            width: 70px;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            text-align: center;
        }

        .ingredient-qty-input::placeholder {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .ingredient-qty-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .ingredient-name-wrapper {
            flex: 1;
            position: relative;
        }

        .ingredient-name-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
        }

        .ingredient-name-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .ingredient-item input[type="text"] {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
        }

        .ingredient-item input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .ingredient-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            line-height: 1;
        }

        .ingredient-remove:hover {
            color: #DC3545;
        }

        /* Autocomplete dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-top: none;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            box-shadow: var(--shadow-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }

        .autocomplete-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-light);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background: var(--accent-green-light);
        }

        .autocomplete-item .autocomplete-aisle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        /* Ingredient Manager */
        .ingredient-manager-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .ingredient-manager-search {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .ingredient-manager-list {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            max-height: 400px;
            overflow-y: auto;
        }

        .ingredient-manager-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        .ingredient-manager-item:last-child {
            border-bottom: none;
        }

        .ingredient-manager-item:hover {
            background: var(--bg-cream);
        }

        .ingredient-manager-name {
            flex: 1;
            font-size: 0.95rem;
        }

        .ingredient-manager-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--bg-cream);
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
        }

        .ingredient-manager-actions {
            display: flex;
            gap: 0.25rem;
        }

        .ingredient-manager-btn {
            background: none;
            border: 1px solid var(--border-light);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .ingredient-manager-btn:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .ingredient-manager-btn.danger:hover {
            border-color: #DC3545;
            color: #DC3545;
        }

        /* Day Notes */
        .day-notes {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border-light);
        }

        .day-notes-toggle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .day-notes-toggle:hover {
            color: var(--accent-green);
        }

        .day-notes-input {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-family: 'Source Sans 3', sans-serif;
            resize: vertical;
            min-height: 50px;
        }

        .day-notes-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .day-notes-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 0.25rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Meal Categories Manager */
        .meal-categories-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        .meal-category-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            background: var(--bg-white);
        }

        .meal-category-input {
            flex: 1;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .meal-category-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .meal-category-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
        }

        .meal-category-btn:hover {
            color: #DC3545;
        }

        .meal-category-btn.move:hover {
            color: var(--accent-green);
        }

        /* Share Shop Button */
        .share-shop-btn {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .share-shop-btn:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: var(--accent-green-light);
        }

        /* Meal Planner Grid */
        .planner-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 900px) {
            .planner-week {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .planner-week {
                grid-template-columns: 1fr;
            }
        }

        .day-card {
            background: var(--bg-white);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .day-header {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--accent-green-light) 0%, #c4f0dc 100%);
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            color: var(--accent-green-dark);
            font-size: 0.9rem;
        }

        .day-header .date {
            font-weight: 400;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .day-meals {
            flex: 1;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .meal-slot {
            background: var(--bg-cream);
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .meal-slot-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meal-slot-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .meal-slot-empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        .meal-slot-actions {
            display: flex;
            gap: 0.25rem;
        }

        .meal-slot-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .meal-slot-btn:hover {
            color: var(--accent-green);
        }

        .meal-slot-btn.remove:hover {
            color: #DC3545;
        }

        /* Day card states */
        .day-card.past {
            opacity: 0.5;
            pointer-events: none;
        }

        .day-card.past .day-header {
            background: var(--border-light);
        }

        .day-card.today {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px var(--accent-green-light);
        }

        .day-card.today .day-header {
            background: linear-gradient(135deg, var(--accent-mint) 0%, var(--accent-green-light) 100%);
        }

        /* Shopping List */
        .shopping-section {
            margin-bottom: 2rem;
        }

        .shopping-section-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-green-light);
            color: var(--accent-green-dark);
        }

        .shopping-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-white);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .shopping-item:hover {
            border-color: var(--border-medium);
        }

        .shopping-item.have {
            background: var(--accent-green-light);
            border-color: var(--accent-green);
        }

        .shopping-item.have .shopping-item-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .shopping-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-green);
        }

        .shopping-item-text {
            flex: 1;
        }

        .shopping-item-recipe {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(45, 42, 38, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Recipe Select in Modal */
        .recipe-select-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
        }

        .recipe-select-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.15s ease;
        }

        .recipe-select-item:last-child {
            border-bottom: none;
        }

        .recipe-select-item:hover {
            background: var(--accent-green-light);
        }

        .recipe-select-item.selected {
            background: var(--accent-green);
            color: white;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* Week Navigation */
        .week-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .week-nav-btn {
            background: var(--bg-white);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .week-nav-btn:hover {
            background: var(--accent-green-light);
            border-color: var(--accent-green);
        }

        .week-display {
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        /* Search Box */
        .search-box {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--bg-white) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B6560' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E") no-repeat 0.75rem center;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px var(--accent-green-light);
        }

        /* Shopping List Summary */
        .shopping-summary {
            background: linear-gradient(135deg, var(--accent-green-light) 0%, #c4f0dc 100%);
            border-radius: var(--radius-md);
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border: 1px solid var(--border-light);
        }

        .shopping-summary-stat {
            text-align: center;
        }

        .shopping-summary-number {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-green-dark);
        }

        .shopping-summary-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Sort Controls */
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .sort-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .sort-select {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            background: var(--bg-white);
            color: var(--text-primary);
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-cream);
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1.5rem;
        }

        .view-toggle-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .view-toggle-btn:hover {
            color: var(--text-primary);
        }

        .view-toggle-btn.active {
            background: var(--bg-white);
            color: var(--accent-green);
            box-shadow: var(--shadow-sm);
        }

        /* Month View */
        .month-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .month-display {
            font-weight: 600;
            min-width: 180px;
            text-align: center;
            font-size: 1.1rem;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--border-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .month-header-cell {
            background: var(--accent-green-light);
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--accent-green-dark);
        }

        .month-day {
            background: var(--bg-white);
            min-height: 120px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .month-day:hover {
            background: var(--bg-cream);
        }

        .month-day.other-month {
            background: var(--bg-cream);
            opacity: 0.5;
        }

        .month-day.past {
            opacity: 0.4;
        }

        .month-day.today {
            background: var(--accent-green-light);
        }

        .month-day-number {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .month-day.today .month-day-number {
            color: var(--accent-green-dark);
        }

        .month-day-meals {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .month-meal-pill {
            font-size: 0.72rem;
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .pill-initial {
            font-weight: 700;
            opacity: 0.75;
        }

        .month-meal-pill.breakfast {
            background: #FEF3C7;
            color: #92400E;
        }

        .month-meal-pill.lunch {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .month-meal-pill.dinner {
            background: #FCE7F3;
            color: #9D174D;
        }

        .month-day-more {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        @media (max-width: 768px) {
            .month-day {
                min-height: 60px;
                padding: 0.25rem;
            }
            
            .month-meal-pill {
                font-size: 0.6rem;
            }
            
            .month-header-cell {
                font-size: 0.7rem;
                padding: 0.35rem;
            }
        }

        /* Date Range Picker */
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.85rem;
            background: var(--bg-white);
            color: var(--text-primary);
            width: 130px;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px var(--accent-green-light);
        }

        .date-range-separator {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .date-preset-btn {
            padding: 0.35rem 0.6rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            background: var(--bg-white);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .date-preset-btn:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .date-preset-btn.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        /* Shopping Controls Row */
        .shopping-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        .shopping-controls-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Add Item Section */
        .add-item-section {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }

        .add-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .add-item-header h4 {
            font-size: 0.95rem;
            color: var(--text-primary);
            margin: 0;
        }

        .add-item-section h4 {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .add-item-row {
            display: flex;
            gap: 0.5rem;
        }

        .add-item-input-wrapper {
            flex: 1;
            position: relative;
        }

        .add-item-input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.95rem;
        }

        .add-item-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px var(--accent-green-light);
        }

        /* Ad-hoc item styling */
        .shopping-item.adhoc .shopping-item-recipe {
            font-style: italic;
        }

        .shopping-item-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .shopping-item-remove:hover {
            opacity: 1;
            color: #DC3545;
        }

        /* Export dropdown */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            z-index: 100;
            min-width: 150px;
            margin-top: 0.25rem;
        }

        .export-menu.show {
            display: block;
        }

        .export-menu-item {
            display: block;
            width: 100%;
            padding: 0.6rem 1rem;
            border: none;
            background: none;
            text-align: left;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .export-menu-item:hover {
            background: var(--accent-green-light);
        }

        /* Print options modal */
        .print-options {
            background: var(--bg-cream);
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
        }

        .print-option-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .print-option-row:last-child {
            margin-bottom: 0;
        }

        /* Settings / Shops & Aisles */
        .settings-section {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
        }

        .settings-section-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-cream);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .settings-section-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .settings-section-body {
            padding: 1.25rem;
        }

        /* Shop Cards */
        .shop-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .shop-card {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .shop-card.default {
            border-color: var(--accent-green);
        }

        .shop-card-header {
            padding: 0.75rem 1rem;
            background: var(--bg-cream);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .shop-card.default .shop-card-header {
            background: var(--accent-green-light);
        }

        .shop-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .shop-default-badge {
            font-size: 0.7rem;
            background: var(--accent-green);
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 500;
        }

        .shop-actions {
            display: flex;
            gap: 0.25rem;
        }

        .shop-action-btn {
            background: none;
            border: none;
            padding: 0.3rem 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.85rem;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }

        .shop-action-btn:hover {
            background: var(--bg-white);
            color: var(--text-primary);
        }

        .shop-action-btn.danger:hover {
            color: #DC3545;
        }

        .shop-collapse-btn {
            background: none;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .shop-collapse-btn:hover {
            background: var(--bg-cream);
            color: var(--text-primary);
        }

        /* Aisle List */
        .aisle-list {
            padding: 0.75rem 1rem;
        }

        .aisle-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
        }

        .aisle-item:last-child {
            margin-bottom: 0;
        }

        .aisle-order {
            width: 24px;
            height: 24px;
            background: var(--accent-green-light);
            color: var(--accent-green-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .aisle-name {
            flex: 1;
        }

        .aisle-move-btns {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .aisle-move-btn {
            background: none;
            border: 1px solid var(--border-light);
            width: 22px;
            height: 16px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.7rem;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .aisle-move-btn:hover {
            background: var(--accent-green-light);
            border-color: var(--accent-green);
            color: var(--accent-green-dark);
        }

        .aisle-delete-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .aisle-delete-btn:hover {
            color: #DC3545;
            opacity: 1;
        }

        .add-aisle-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border-light);
        }

        .add-aisle-input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .add-aisle-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        /* Empty state for shops */
        .shops-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        /* Ingredient Dictionary */
        .dictionary-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .dictionary-search {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .dictionary-search:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px var(--accent-green-light);
        }

        .dictionary-filter {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            background: var(--bg-white);
        }

        .dictionary-stats {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-cream);
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .dictionary-stat {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .dictionary-stat-value {
            font-weight: 600;
            color: var(--accent-green-dark);
        }

        .dictionary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .dictionary-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--bg-cream);
            border-bottom: 2px solid var(--border-light);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .dictionary-table td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .dictionary-table tr:hover {
            background: var(--bg-cream);
        }

        .dictionary-ingredient {
            font-weight: 500;
        }

        .dictionary-aisle {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.5rem;
            background: var(--accent-green-light);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: var(--accent-green-dark);
        }

        .dictionary-aisle.uncategorised {
            background: var(--bg-cream);
            color: var(--text-secondary);
        }

        .dictionary-aisle-select {
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            background: var(--bg-white);
            min-width: 140px;
        }

        .dictionary-remove-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .dictionary-remove-btn:hover {
            color: #DC3545;
            opacity: 1;
        }

        .dictionary-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .dictionary-shop-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .dictionary-shop-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: var(--bg-white);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.15s;
        }

        .dictionary-shop-tab:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .dictionary-shop-tab.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .dictionary-bulk-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-cream);
            border-radius: var(--radius-sm);
            align-items: center;
        }

        .dictionary-bulk-select {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            min-width: 150px;
        }

        /* Shop selector on shopping list */
        .shop-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
        }

        .shop-selector-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .shop-selector-select {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            background: var(--bg-white);
            color: var(--text-primary);
            cursor: pointer;
        }

        /* Aisle section headers in shopping list */
        .aisle-section {
            margin-bottom: 1.5rem;
        }

        .aisle-section-title {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--accent-green-light);
            border-radius: var(--radius-sm);
            color: var(--accent-green-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .aisle-section-order {
            width: 22px;
            height: 22px;
            background: var(--accent-green);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Set aisle button on shopping items */
        .set-aisle-btn {
            font-size: 0.75rem;
            color: var(--accent-green);
            background: none;
            border: 1px dashed var(--accent-green);
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            white-space: nowrap;
        }

        .set-aisle-btn:hover {
            background: var(--accent-green-light);
        }

        /* Aisle select dropdown */
        .aisle-select-dropdown {
            position: absolute;
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            z-index: 100;
            min-width: 150px;
            max-height: 200px;
            overflow-y: auto;
        }

        .aisle-select-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-light);
        }

        .aisle-select-option:last-child {
            border-bottom: none;
        }

        .aisle-select-option:hover {
            background: var(--accent-green-light);
        }

        /* Print Styles */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                font-size: 12pt;
                margin: 0;
                padding: 1rem;
            }
            
            /* Hide all the app UI */
            .loading-overlay,
            .auth-screen,
            .sync-status,
            .app-container,
            .modal-overlay {
                display: none !important;
            }
            
            /* Show only print-specific elements */
            .print-header,
            .print-date,
            .print-shopping-content,
            .print-planner-content {
                display: block !important;
            }

            /* Hide planner-specific print divs when printing shopping list, and vice versa */
            body.printing-shopping .print-planner-content { display: none !important; }
            body.printing-planner .print-shopping-content { display: none !important; }
            body.printing-planner .print-header { display: none !important; }
            body.printing-planner .print-date:not(#print-planner-date) { display: none !important; }
            
            /* Print header styling */
            .print-header {
                text-align: center;
                margin-bottom: 0.5rem;
                font-size: 18pt;
                font-weight: bold;
            }
            
            .print-header h1 {
                margin: 0;
                font-size: 18pt;
            }
            
            .print-date {
                text-align: center;
                font-size: 10pt;
                color: #666;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #ccc;
            }
            
            /* Print content container */
            .print-shopping-content {
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            }
            
            .print-shopping-content .print-aisle-section {
                margin-bottom: 1rem;
            }
            
            .print-shopping-content .print-aisle-title {
                font-weight: bold;
                font-size: 11pt;
                padding: 0.3rem 0;
                border-bottom: 1px solid #999;
                margin-bottom: 0.3rem;
            }
            
            .print-shopping-content .print-item {
                display: flex !important;
                align-items: flex-start;
                gap: 0.5rem;
                padding: 0.25rem 0;
                border-bottom: 1px dotted #ddd;
                page-break-inside: avoid;
            }
            
            .print-shopping-content .print-checkbox {
                width: 12px;
                height: 12px;
                border: 1px solid #333;
                flex-shrink: 0;
                margin-top: 2px;
            }
            
            .print-shopping-content .print-item-text {
                font-size: 10pt;
                flex: 1;
            }
            
            .print-shopping-content .print-item-context {
                font-size: 8pt;
                color: #666;
            }

            /* ‚îÄ‚îÄ Meal Plan Print Layouts ‚îÄ‚îÄ */
            .print-planner-content {
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            }

            /* Week view grid */
            .print-week-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
                width: 100%;
            }

            .print-day-card {
                border: 1px solid #bbb;
                page-break-inside: avoid;
                font-size: 8pt;
            }

            .print-day-header {
                background: #d4eedd;
                padding: 4px 6px;
                font-weight: 700;
                font-size: 8.5pt;
                border-bottom: 1px solid #bbb;
            }

            .print-day-header .print-day-date {
                font-weight: 400;
                font-size: 7pt;
                color: #555;
            }

            .print-meal-slot {
                padding: 3px 5px;
                border-bottom: 1px dotted #ddd;
            }

            .print-meal-slot:last-child {
                border-bottom: none;
            }

            .print-meal-label {
                font-size: 6.5pt;
                color: #888;
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }

            .print-meal-name {
                font-size: 8pt;
                color: #111;
                line-height: 1.3;
            }

            .print-day-note {
                padding: 3px 5px;
                font-size: 7pt;
                color: #555;
                font-style: italic;
                border-top: 1px solid #eee;
            }

            /* Month view grid */
            .print-month-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
                width: 100%;
            }

            .print-month-header-cell {
                background: #d4eedd;
                padding: 4px;
                text-align: center;
                font-weight: 700;
                font-size: 8.5pt;
                border: 1px solid #bbb;
            }

            .print-month-day {
                border: 1px solid #bbb;
                min-height: 75px;
                padding: 3px 4px;
                vertical-align: top;
                font-size: 7.5pt;
                page-break-inside: avoid;
            }

            .print-month-day.other-month {
                background: #f0f0f0;
                color: #aaa;
            }

            .print-month-day-number {
                font-weight: 700;
                font-size: 8.5pt;
                margin-bottom: 2px;
                color: #222;
            }

            .print-month-meal {
                padding: 1px 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 7pt;
                line-height: 1.3;
            }

            .print-month-meal .print-month-meal-label {
                font-weight: 700;
                color: #444;
            }
        }
        
        .print-header, .print-date, .print-shopping-content, .print-planner-content {
            display: none;
        }

        /* Sharing UI */
        .share-link-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .share-link-input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-family: monospace;
            font-size: 0.85rem;
            background: var(--bg-cream);
        }

        .share-link-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .copy-btn {
            padding: 0.6rem 1rem;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: var(--accent-green-dark);
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .share-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
        }

        /* Import preview */
        .import-preview {
            background: var(--bg-cream);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
        }

        .import-preview-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .import-preview-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .import-preview-list {
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .import-preview-item {
            padding: 0.25rem 0;
            border-bottom: 1px dotted var(--border-light);
        }

        .import-preview-item:last-child {
            border-bottom: none;
        }

        .import-type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .import-type-badge.recipe {
            background: #FEF3C7;
            color: #92400E;
        }

        .import-type-badge.shop {
            background: #DBEAFE;
            color: #1E40AF;
        }

        /* Share button in cards */
        .share-btn {
            background: none;
            border: 1px solid var(--border-light);
            padding: 0.3rem 0.6rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.15s;
        }

        .share-btn:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: var(--accent-green-light);
        }

        /* Welcome Modal */
        .welcome-modal {
            max-width: 520px;
        }

        .welcome-step {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .welcome-step:last-child {
            border-bottom: none;
        }

        .welcome-step-icon {
            font-size: 2rem;
            line-height: 1;
        }

        .welcome-step-content h4 {
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .welcome-step-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .welcome-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-skip {
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .welcome-skip:hover {
            color: var(--accent-green);
        }

        /* Help Section */
        .help-modal {
            max-width: 600px;
            max-height: 80vh;
        }

        .help-modal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .help-section {
            margin-bottom: 1.5rem;
        }

        .help-section-title {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: var(--accent-green-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-item {
            background: var(--bg-cream);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            overflow: hidden;
        }

        .help-question {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        .help-question:hover {
            background: var(--accent-green-light);
        }

        .help-question-icon {
            transition: transform 0.2s;
        }

        .help-item.open .help-question-icon {
            transform: rotate(180deg);
        }

        .help-answer {
            display: none;
            padding: 0 1rem 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .help-item.open .help-answer {
            display: block;
        }

        .help-tip {
            background: var(--accent-green-light);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .help-tip strong {
            color: var(--accent-green-dark);
        }

        /* Help button in header */
        .help-btn {
            background: none;
            border: 1px solid var(--border-light);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: var(--accent-green-light);
        }

        /* PWA Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-white);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
            max-width: 400px;
            width: calc(100% - 2rem);
        }

        .install-prompt-icon {
            font-size: 2rem;
        }

        .install-prompt-text h4 {
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .install-prompt-text p {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin: 0;
        }

        .install-prompt-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .install-prompt-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        /* Utility Classes */
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-secondary); }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Auth Screen -->
    <div class="auth-screen" id="auth-screen">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-text">kitchen<span class="logo-highlight">listr</span></div>
            </div>

            <div class="auth-error" id="auth-error"></div>

            <div class="auth-tabs">
                <button class="auth-tab active" id="tab-signin" onclick="showAuthTab('signin')">Sign In</button>
                <button class="auth-tab" id="tab-signup" onclick="showAuthTab('signup')">Sign Up</button>
            </div>

            <!-- Sign In Form -->
            <form class="auth-form active" id="signin-form" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label class="form-label" for="signin-email">Email</label>
                    <input type="email" class="form-input" id="signin-email" required placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signin-password">Password</label>
                    <input type="password" class="form-input" id="signin-password" required placeholder="Your password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="signin-btn">Sign In</button>
            </form>

            <!-- Sign Up Form -->
            <form class="auth-form" id="signup-form" onsubmit="handleSignUp(event)">
                <div class="form-group">
                    <label class="form-label" for="signup-email">Email</label>
                    <input type="email" class="form-input" id="signup-email" required placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signup-password">Password</label>
                    <input type="password" class="form-input" id="signup-password" required placeholder="At least 6 characters" minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signup-password-confirm">Confirm Password</label>
                    <input type="password" class="form-input" id="signup-password-confirm" required placeholder="Confirm your password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="signup-btn">Create Account</button>
            </form>

            <div class="auth-divider"><span>or</span></div>

            <button class="google-btn" onclick="handleGoogleSignIn()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Sync Status -->
    <div class="sync-status hidden" id="sync-status">
        <span class="sync-dot" id="sync-dot"></span>
        <span id="sync-text">Synced</span>
    </div>

    <!-- App Container -->
    <div class="app-container" id="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a class="logo" href="#" onclick="event.preventDefault(); showView('recipes');">
                    <span class="logo-text">kitchen<span class="logo-highlight">listr</span></span>
                </a>
                <nav class="nav">
                    <button class="nav-btn active" data-view="recipes">Recipes</button>
                    <button class="nav-btn" data-view="planner">Meal Plan</button>
                    <button class="nav-btn" data-view="shopping">Shopping List</button>
                    <button class="nav-btn" data-view="settings">Settings</button>
                </nav>
                <div class="header-right">
                    <button class="help-btn" onclick="openHelpModal()" title="Help">?</button>
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">?</div>
                        <span id="user-email"></span>
                    </div>
                    <button class="sign-out-btn" onclick="handleSignOut()">Sign Out</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Recipes View -->
            <section id="recipes-view" class="view active">
                <div class="page-header">
                    <h1 class="page-title">Recipes</h1>
                    <div>
                        <button class="btn btn-secondary" onclick="shareBulkRecipes()">
                            Share Recipes
                        </button>
                        <button class="btn btn-primary" onclick="openAddRecipeModal()">
                            + Add Recipe
                        </button>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="recipe-search" placeholder="Search recipes..." oninput="filterRecipes()">
                </div>
                
                <div id="recipes-grid" class="recipe-grid">
                    <!-- Recipes will be rendered here -->
                </div>
                
                <div id="recipes-empty" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üìñ</div>
                    <h3 class="empty-state-title">No recipes yet</h3>
                    <p>Add your first recipe to get started!</p>
                </div>
            </section>

            <!-- Planner View -->
            <section id="planner-view" class="view">
                <div class="page-header">
                    <h1 class="page-title">Meal Plan</h1>
                    <button class="btn btn-secondary" onclick="openPlannerPrintModal()">Print Plan</button>
                </div>
                
                <!-- View Toggle -->
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="week-view-btn" onclick="showPlannerView('week')">Week</button>
                    <button class="view-toggle-btn" id="month-view-btn" onclick="showPlannerView('month')">Month</button>
                </div>
                
                <!-- Week View -->
                <div id="week-view-container">
                    <div class="week-nav">
                        <button class="week-nav-btn" onclick="changeWeek(-1)">‚Üê Previous</button>
                        <span class="week-display" id="week-display"></span>
                        <button class="week-nav-btn" onclick="changeWeek(1)">Next ‚Üí</button>
                    </div>
                    
                    <div id="planner-week" class="planner-week">
                        <!-- Days will be rendered here -->
                    </div>
                </div>
                
                <!-- Month View -->
                <div id="month-view-container" style="display: none;">
                    <div class="month-nav">
                        <button class="week-nav-btn" onclick="changeMonth(-1)">‚Üê Previous</button>
                        <span class="month-display" id="month-display"></span>
                        <button class="week-nav-btn" onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                    
                    <div id="planner-month" class="month-grid">
                        <!-- Month grid will be rendered here -->
                    </div>
                </div>
            </section>

            <!-- Shopping View -->
            <section id="shopping-view" class="view">
                <div class="page-header">
                    <h1 class="page-title">Shopping List</h1>
                    <div>
                        <button class="btn btn-secondary" onclick="clearHaveItems()">Clear Checked</button>
                        <div class="export-dropdown">
                            <button class="btn btn-secondary" onclick="toggleExportMenu()">Export ‚ñæ</button>
                            <div class="export-menu" id="export-menu">
                                <button class="export-menu-item" onclick="exportAsText()">üìÑ Copy as Text</button>
                                <button class="export-menu-item" onclick="exportAsCSV()">üìä Download CSV</button>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="openPrintModal()">Print List</button>
                    </div>
                </div>
                
                <div class="shopping-summary" id="shopping-summary">
                    <!-- Summary will be rendered here -->
                </div>
                
                <!-- Add Item Section -->
                <div class="add-item-section">
                    <div class="add-item-header">
                        <h4>‚ûï Add extra item</h4>
                        <button class="btn btn-secondary btn-small" onclick="clearCheckedAdhocItems()">Remove checked extras</button>
                    </div>
                    <div class="add-item-row">
                        <div class="add-item-input-wrapper">
                            <input type="text" class="add-item-input" id="add-item-input" placeholder="e.g., Kitchen roll, Bin bags..." onkeypress="handleAddItemKeypress(event)" oninput="showAdHocAutocomplete(this)" onblur="hideAdHocAutocomplete(this)" autocomplete="off">
                        </div>
                        <button class="btn btn-primary btn-small" onclick="addAdHocItem()">Add</button>
                    </div>
                </div>
                
                <!-- Shop Selector -->
                <div class="shop-selector" id="shop-selector-container" style="display: none;">
                    <span class="shop-selector-label">üè™ Shopping at:</span>
                    <select class="shop-selector-select" id="shop-selector" onchange="onShopChange()">
                        <!-- Options populated by JS -->
                    </select>
                    <a href="#" onclick="event.preventDefault(); showView('settings');" style="font-size: 0.85rem; color: var(--accent-green);">Manage shops</a>
                </div>
                
                <!-- Controls Row -->
                <div class="shopping-controls">
                    <div class="shopping-controls-group">
                        <span class="sort-label">Sort by:</span>
                        <select class="sort-select" id="sort-select" onchange="renderShoppingList()">
                            <option value="alpha">A-Z (Alphabetical)</option>
                            <option value="aisle">Aisle order</option>
                            <option value="day">Date order</option>
                            <option value="recipe">Recipe</option>
                        </select>
                    </div>
                    <div class="shopping-controls-group">
                        <span class="sort-label">Date range:</span>
                        <div class="date-range-picker">
                            <input type="date" class="date-input" id="date-from" onchange="onDateRangeChange()">
                            <span class="date-range-separator">to</span>
                            <input type="date" class="date-input" id="date-to" onchange="onDateRangeChange()">
                        </div>
                    </div>
                    <div class="shopping-controls-group">
                        <button class="date-preset-btn" data-preset="today" onclick="setDatePreset('today')">Today</button>
                        <button class="date-preset-btn" data-preset="3days" onclick="setDatePreset('3days')">3 days</button>
                        <button class="date-preset-btn active" data-preset="7days" onclick="setDatePreset('7days')">7 days</button>
                        <button class="date-preset-btn" data-preset="week" onclick="setDatePreset('week')">This week</button>
                        <button class="date-preset-btn" data-preset="all" onclick="setDatePreset('all')">All</button>
                    </div>
                </div>
                
                <div id="shopping-list">
                    <!-- Shopping list will be rendered here -->
                </div>
                
                <div id="shopping-empty" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üõí</div>
                    <h3 class="empty-state-title">No items to buy</h3>
                    <p>Add meals to your plan or add extra items above.</p>
                </div>
            </section>

            <!-- Settings View -->
            <section id="settings-view" class="view">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>
                
                <!-- Shops & Aisles Section -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h2 class="settings-section-title">üè™ Shops & Aisles</h2>
                        <button class="btn btn-primary btn-small" onclick="openAddShopModal()">+ Add Shop</button>
                    </div>
                    <div class="settings-section-body">
                        <p class="text-muted mb-2">Set up your shops and their aisle layouts. When sorting your shopping list by aisle, items will appear in the order you walk through the store.</p>
                        
                        <div id="shops-list" class="shop-list">
                            <!-- Shops will be rendered here -->
                        </div>
                        
                        <div id="shops-empty" class="shops-empty" style="display: none;">
                            <p>No shops set up yet.</p>
                            <button class="btn btn-primary mt-1" onclick="openAddShopModal()">Add your first shop</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ingredient Dictionary Section -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h2 class="settings-section-title">üìñ Ingredient Dictionary</h2>
                    </div>
                    <div class="settings-section-body">
                        <p class="text-muted mb-2">Manage which aisle each ingredient belongs to. Ingredients are remembered per shop, so "milk" can be in different aisles at different stores.</p>
                        
                        <div id="dictionary-no-shops" style="display: none;">
                            <div class="dictionary-empty">
                                <p>Add a shop first to start categorising ingredients.</p>
                            </div>
                        </div>
                        
                        <div id="dictionary-container">
                            <!-- Shop tabs -->
                            <div class="dictionary-shop-tabs" id="dictionary-shop-tabs">
                                <!-- Rendered by JS -->
                            </div>
                            
                            <!-- Stats -->
                            <div class="dictionary-stats" id="dictionary-stats">
                                <!-- Rendered by JS -->
                            </div>
                            
                            <!-- Controls -->
                            <div class="dictionary-controls">
                                <input type="text" class="dictionary-search" id="dictionary-search" placeholder="Search ingredients..." oninput="renderIngredientDictionary()">
                                <select class="dictionary-filter" id="dictionary-filter" onchange="renderIngredientDictionary()">
                                    <option value="all">All ingredients</option>
                                    <option value="categorised">Categorised only</option>
                                    <option value="uncategorised">Uncategorised only</option>
                                </select>
                            </div>
                            
                            <!-- Bulk actions for uncategorised -->
                            <div class="dictionary-bulk-actions" id="dictionary-bulk-actions" style="display: none;">
                                <span style="font-size: 0.85rem;">Bulk assign uncategorised to:</span>
                                <select class="dictionary-bulk-select" id="dictionary-bulk-aisle">
                                    <!-- Options rendered by JS -->
                                </select>
                                <button class="btn btn-primary btn-small" onclick="bulkAssignAisle()">Apply to Selected</button>
                                <button class="btn btn-secondary btn-small" onclick="selectAllUncategorised()">Select All Uncategorised</button>
                            </div>
                            
                            <!-- Table -->
                            <div style="overflow-x: auto;">
                                <table class="dictionary-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 30px;"><input type="checkbox" id="dictionary-select-all" onchange="toggleSelectAllIngredients()"></th>
                                            <th>Ingredient</th>
                                            <th>Aisle</th>
                                            <th style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="dictionary-table-body">
                                        <!-- Rendered by JS -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="dictionary-empty" class="dictionary-empty" style="display: none;">
                                <p>No ingredients found. Add meals to your plan to start building your ingredient dictionary.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ingredient Manager Section -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h2 class="settings-section-title">ü•ï Ingredient Manager</h2>
                    </div>
                    <div class="settings-section-body">
                        <p class="text-muted mb-2">Edit, rename, or merge ingredients across all your recipes. Changes here will update every recipe that uses the ingredient.</p>
                        
                        <div class="ingredient-manager-controls">
                            <input type="text" class="ingredient-manager-search" id="ingredient-manager-search" placeholder="Search ingredients..." oninput="renderIngredientManager()">
                        </div>
                        
                        <div class="ingredient-manager-list" id="ingredient-manager-list">
                            <!-- Rendered by JS -->
                        </div>
                        
                        <div id="ingredient-manager-empty" class="dictionary-empty" style="display: none;">
                            <p>No ingredients found. Add recipes to get started.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Meal Categories Section -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <h2 class="settings-section-title">üçΩÔ∏è Meal Categories</h2>
                    </div>
                    <div class="settings-section-body">
                        <p class="text-muted mb-2">Customise the meal categories shown in your meal planner. Add categories like "Kids' Dinner" or "Snack".</p>
                        
                        <div id="meal-categories-list">
                            <!-- Rendered by JS -->
                        </div>
                        
                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="new-meal-category" placeholder="New category name..." style="flex: 1;">
                            <button class="btn btn-primary btn-small" onclick="addMealCategory()">Add Category</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Recipe Modal -->
    <div class="modal-overlay" id="recipe-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="recipe-modal-title">Add Recipe</h2>
                <button class="modal-close" onclick="closeRecipeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="recipe-form" onsubmit="saveRecipe(event)">
                    <input type="hidden" id="recipe-id">
                    
                    <div class="form-group">
                        <label class="form-label" for="recipe-name">Recipe Name *</label>
                        <input type="text" class="form-input" id="recipe-name" required placeholder="e.g., Spaghetti Bolognese">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" id="recipe-title-only" onchange="toggleIngredientsSection()">
                            <span>Title only (no ingredients needed)</span>
                        </label>
                        <p class="form-hint">Use this for takeaways, eating out, or meals you don't need to shop for.</p>
                    </div>
                    
                    <div id="ingredients-section">
                        <div class="form-group">
                            <label class="form-label">Ingredients</label>
                            
                            <div class="ingredients-toggle">
                                <button type="button" class="toggle-btn active" id="toggle-single" onclick="showIngredientMode('single')">Add one by one</button>
                                <button type="button" class="toggle-btn" id="toggle-bulk" onclick="showIngredientMode('bulk')">Paste list</button>
                            </div>
                            
                            <div id="single-ingredient-mode">
                                <p class="form-hint mb-1">Add quantity and ingredient name separately</p>
                                <ul class="ingredients-list" id="ingredients-list">
                                    <!-- Ingredient inputs will be added here -->
                                </ul>
                                <button type="button" class="btn btn-secondary btn-small mt-1" onclick="addIngredientInput()">
                                    + Add Ingredient
                                </button>
                            </div>
                            
                            <div id="bulk-ingredient-mode" style="display: none;">
                                <p class="form-hint mb-1">Paste your ingredients below, one per line (will be imported as names without quantities)</p>
                                <textarea class="form-textarea" id="bulk-ingredients" placeholder="tinned tomatoes
onion
garlic cloves
minced beef
oregano"></textarea>
                                <button type="button" class="btn btn-secondary btn-small mt-1" onclick="applyBulkIngredients()">
                                    Apply to list
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="recipe-notes">Notes (optional)</label>
                        <textarea class="form-textarea" id="recipe-notes" placeholder="Cooking instructions, tips, or variations..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRecipeModal()">Cancel</button>
                <button type="submit" form="recipe-form" class="btn btn-primary">Save Recipe</button>
            </div>
        </div>
    </div>

    <!-- View Recipe Modal -->
    <div class="modal-overlay" id="view-recipe-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="view-recipe-title"></h2>
                <button class="modal-close" onclick="closeViewRecipeModal()">&times;</button>
            </div>
            <div class="modal-body" id="view-recipe-body">
                <!-- Recipe details will be rendered here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteCurrentRecipe()">Delete</button>
                <button type="button" class="btn btn-secondary" onclick="shareRecipe()">Share</button>
                <button type="button" class="btn btn-secondary" onclick="editCurrentRecipe()">Edit</button>
                <button type="button" class="btn btn-primary" onclick="closeViewRecipeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Select Recipe Modal -->
    <div class="modal-overlay" id="select-recipe-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Select a Recipe</h2>
                <button class="modal-close" onclick="closeSelectRecipeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="select-recipe-date">
                <input type="hidden" id="select-recipe-meal">

                <!-- Quick Add Recipe (inline) -->
                <div id="quick-add-recipe-form" style="display: none; border: 1px solid var(--border-light); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1rem; background: var(--bg-cream);">
                    <h4 style="font-size: 0.95rem; margin-bottom: 0.75rem; font-family: 'Fraunces', serif;">Quick Add Recipe</h4>
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                        <input type="text" class="form-input" id="quick-recipe-name" placeholder="Recipe name..." style="width: 100%;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                        <label class="form-checkbox">
                            <input type="checkbox" id="quick-recipe-title-only">
                            <span>Title only (no ingredients needed)</span>
                        </label>
                    </div>
                    <p class="form-hint" style="margin-bottom: 0.75rem;">You can add ingredients and details later on the Recipes page.</p>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary btn-small" onclick="toggleQuickAddRecipeForm()">Cancel</button>
                        <button type="button" class="btn btn-primary btn-small" onclick="saveQuickRecipeForMeal()">Save & Select</button>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" class="search-input" id="select-recipe-search" placeholder="Search recipes..." oninput="filterRecipeSelect()">
                </div>

                <div class="recipe-select-list" id="recipe-select-list">
                    <!-- Recipes will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSelectRecipeModal()">Cancel</button>
                <button type="button" class="btn btn-secondary" onclick="toggleQuickAddRecipeForm()">+ New Recipe</button>
            </div>
        </div>
    </div>

    <!-- Print Options Modal -->
    <div class="modal-overlay" id="print-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Print Shopping List</h2>
                <button class="modal-close" onclick="closePrintModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-options">
                    <div class="print-option-row">
                        <label class="form-checkbox">
                            <input type="checkbox" id="print-hide-checked" checked>
                            <span>Hide checked items (already have)</span>
                        </label>
                    </div>
                </div>
                <p class="text-muted" style="font-size: 0.85rem;">The printed list will show a clean, minimal format suitable for taking to the shops.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePrintModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="printShoppingList()">Print</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Shop Modal -->
    <div class="modal-overlay" id="shop-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="shop-modal-title">Add Shop</h2>
                <button class="modal-close" onclick="closeShopModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="shop-form" onsubmit="saveShop(event)">
                    <input type="hidden" id="shop-id">
                    
                    <div class="form-group">
                        <label class="form-label" for="shop-name">Shop Name *</label>
                        <input type="text" class="form-input" id="shop-name" required placeholder="e.g., Tesco Extra Purley">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" id="shop-default">
                            <span>Set as default shop</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeShopModal()">Cancel</button>
                <button type="submit" form="shop-form" class="btn btn-primary">Save Shop</button>
            </div>
        </div>
    </div>

    <!-- Edit Ingredient Modal -->
    <div class="modal-overlay" id="edit-ingredient-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Ingredient</h2>
                <button class="modal-close" onclick="closeEditIngredientModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-ingredient-original">
                
                <div class="form-group">
                    <label class="form-label" for="edit-ingredient-name">Ingredient Name</label>
                    <input type="text" class="form-input" id="edit-ingredient-name" placeholder="e.g., tinned tomatoes">
                    <p class="form-hint">Renaming this will update all recipes that use it.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Used in recipes:</label>
                    <div id="edit-ingredient-recipes" class="text-muted" style="font-size: 0.9rem; max-height: 100px; overflow-y: auto;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Merge with another ingredient</label>
                    <select class="form-input" id="edit-ingredient-merge">
                        <option value="">Don't merge</option>
                        <!-- Options populated by JS -->
                    </select>
                    <p class="form-hint">Merging will replace this ingredient with the selected one in all recipes.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteIngredient()">Delete</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditIngredientModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveIngredientEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="modal-overlay" id="welcome-modal">
        <div class="modal welcome-modal">
            <div class="modal-header">
                <h2 class="modal-title">üëã Welcome to KitchenListr!</h2>
            </div>
            <div class="modal-body">
                <p class="mb-2">Your meal planning made simple. Here's how to get started:</p>
                
                <div class="welcome-step">
                    <div class="welcome-step-icon">üìñ</div>
                    <div class="welcome-step-content">
                        <h4>1. Add Your Recipes</h4>
                        <p>Save your favourite meals with their ingredients. Use "title only" for takeaways or eating out.</p>
                    </div>
                </div>
                
                <div class="welcome-step">
                    <div class="welcome-step-icon">üìÖ</div>
                    <div class="welcome-step-content">
                        <h4>2. Plan Your Week</h4>
                        <p>Drag recipes onto your meal plan. Plan breakfast, lunch, dinner - or add your own meal categories.</p>
                    </div>
                </div>
                
                <div class="welcome-step">
                    <div class="welcome-step-icon">üõí</div>
                    <div class="welcome-step-content">
                        <h4>3. Shop with Ease</h4>
                        <p>Your shopping list builds automatically. Organise by aisle and tick items off as you shop.</p>
                    </div>
                </div>
                
                <div class="welcome-step">
                    <div class="welcome-step-icon">üè™</div>
                    <div class="welcome-step-content">
                        <h4>4. Set Up Your Shops</h4>
                        <p>In Settings, add your shops and aisles. Assign ingredients once - they'll always sort correctly.</p>
                    </div>
                </div>
                
                <div class="welcome-footer">
                    <span class="welcome-skip" onclick="closeWelcomeModal(true)">Don't show again</span>
                    <button class="btn btn-primary" onclick="closeWelcomeModal(false)">Get Started!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal help-modal">
            <div class="modal-header">
                <h2 class="modal-title">‚ùì Help & FAQ</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body">
                
                <div class="help-section">
                    <h3 class="help-section-title">üìñ Recipes</h3>
                    
                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            How do I add a recipe?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Click the <strong>"+ Add Recipe"</strong> button on the Recipes page. Enter the recipe name and add ingredients one by one, or paste multiple ingredients at once using bulk mode.
                            <div class="help-tip"><strong>Tip:</strong> Use "Title only" for takeaways or meals you don't need to shop for.</div>
                        </div>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Can I share recipes with others?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Yes! Open a recipe and click <strong>"Share"</strong> to get a link. Anyone with the link can import the recipe to their own account. You can also share multiple recipes at once using the "Share Recipes" button.
                        </div>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3 class="help-section-title">üìÖ Meal Planning</h3>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            How do I plan a meal?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Go to the <strong>Meal Plan</strong> page and click the <strong>‚ûï</strong> button on any meal slot. Select a recipe from your list and it will be added to that day.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Can I print or save the meal plan as a PDF?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Yes! Click <strong>"Print Plan"</strong> at the top of the Meal Plan page. Choose <strong>Week view</strong> (current week) or <strong>Month view</strong> (current month), then click Print. In your browser's print dialog, select <strong>"Save as PDF"</strong> to save a file you can email or share, or choose a printer to print a physical copy.
                            <div class="help-tip"><strong>Tip:</strong> Landscape orientation usually works best for the week view ‚Äî you can change this in the print dialog.</div>
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            What does the month view show?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            The month view shows a full calendar with each meal displayed inside its day cell. Each pill shows the meal category initial (e.g. <strong>B</strong> for Breakfast, <strong>L</strong> for Lunch, <strong>D</strong> for Dinner) followed by the recipe name. Click any day to jump to that week in the week view.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Can I add a new recipe while planning a meal?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Yes! When the recipe selection dialog opens, click <strong>"+ New Recipe"</strong> to quickly add a recipe on the fly. Just enter the name (and optionally tick "Title only") and click <strong>"Save &amp; Select"</strong> ‚Äî it will be saved and immediately assigned to that meal slot. You can go back and add ingredients later on the Recipes page.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Can I add custom meal categories?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Yes! Go to <strong>Settings ‚Üí Meal Categories</strong> to add new categories like "Kids' Dinner" or "Snack". You can also rename, reorder, or delete existing categories.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            What are day notes?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Each day has a <strong>"üìù Add note"</strong> option where you can add reminders like "Guests coming" or "Defrost chicken". Notes appear on your meal plan.
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3 class="help-section-title">üõí Shopping List</h3>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            How does the shopping list work?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Your shopping list is built automatically from all recipes in your meal plan for the selected date range. Tick items off as you shop. Use the date range filter or quick presets (Today, 3 days, 7 days, This week, All) to adjust which dates are included.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            What do the date range presets mean?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            <strong>Today</strong> ‚Äî only today's meals.<br>
                            <strong>3 days</strong> ‚Äî today plus the next 2 days.<br>
                            <strong>7 days</strong> ‚Äî today plus the next 6 days (rolling week). This is the default.<br>
                            <strong>This week</strong> ‚Äî the current calendar week (Monday to Sunday).<br>
                            <strong>All</strong> ‚Äî everything from this week up to 30 days ahead.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Why does the shopping list show a date instead of a day name?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Each item shows the full calendar date (e.g. "12 April 2026") rather than just the day name. This helps you know the target best-before date you need when shopping for perishable items.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Can I add items that aren't in recipes?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Yes! Use <strong>"Add extra item"</strong> at the top of the shopping list to add things like toilet roll or cleaning supplies. As you type, suggestions appear from your recipe ingredients and items you've added before ‚Äî making it easy to re-add frequent items with their aisle already set. Extra items stay until you delete them with the <strong>‚úï</strong> button.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            How do I remove extra items I no longer need?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Tick the extra items as <strong>"Already Have"</strong>, then click <strong>"Remove checked extras"</strong> in the extra items section. This permanently deletes all checked extra items in one go. You can also delete individual items using the <strong>‚úï</strong> button next to each one.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            What does the Export option include?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            The <strong>Copy as Text</strong> and <strong>Download CSV</strong> exports only include items you still need to buy ‚Äî items marked as "Already Have" and meals from past dates are excluded. Each item shows the full calendar date so you know what best-before date to look for.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            How do I organise items by aisle?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Go to <strong>Settings ‚Üí Shops &amp; Aisles</strong> to create your shop layout. Then in <strong>Ingredient Dictionary</strong>, assign each ingredient to an aisle. Your shopping list will then sort items by aisle order.
                            <div class="help-tip"><strong>Tip:</strong> Share your shop layout with family members so everyone has the same aisle order!</div>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3 class="help-section-title">‚öôÔ∏è Settings &amp; Data</h3>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            How do I manage my shops and aisles?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Go to <strong>Settings ‚Üí Shops &amp; Aisles</strong>. Click <strong>"‚ñº Aisles"</strong> next to any shop to expand or collapse its aisle list ‚Äî useful when you have multiple shops. Use the <strong>‚ñ≤ ‚ñº</strong> buttons to reorder aisles to match the order you walk through the store.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Is my data saved securely?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Yes! Your data is stored securely in the cloud and syncs automatically across all your devices. Sign in with the same account to access your recipes and meal plans anywhere.
                        </div>
                    </div>

                    <div class="help-item">
                        <div class="help-question" onclick="toggleHelpItem(this)">
                            Can I install this as an app?
                            <span class="help-question-icon">‚ñº</span>
                        </div>
                        <div class="help-answer">
                            Yes! On your phone or tablet, tap the share button and select <strong>"Add to Home Screen"</strong>. On desktop Chrome, look for the install icon in the address bar. The app works offline too!
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="openWelcomeModal()">Show Welcome Guide</button>
                <button type="button" class="btn btn-primary" onclick="closeHelpModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="share-modal-title">Share</h2>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="share-modal-description">Anyone with this link can import this to their account.</p>
                
                <div class="share-link-container">
                    <input type="text" class="share-link-input" id="share-link-input" readonly>
                    <button class="copy-btn" id="copy-share-btn" onclick="copyShareLink()">Copy</button>
                </div>
                
                <p class="share-info">üí° The link never expires. You can regenerate a new link anytime.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeShareModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Bulk Share Recipes Modal -->
    <div class="modal-overlay" id="bulk-share-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Share Multiple Recipes</h2>
                <button class="modal-close" onclick="closeBulkShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="bulk-share-list">
                    <!-- Recipe checkboxes rendered by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBulkShareModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmBulkShare()">Create Share Link</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="import-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Import Shared Item</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="import-loading" style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner" style="position: static; width: 40px; height: 40px; margin: 0 auto 1rem;"></div>
                    <p>Loading shared item...</p>
                </div>
                
                <div id="import-error" style="display: none; text-align: center; padding: 2rem;">
                    <p style="color: #DC3545;">‚ùå Could not find this shared item. It may have been deleted.</p>
                </div>
                
                <div id="import-preview-container" style="display: none;">
                    <div class="import-preview">
                        <span class="import-type-badge" id="import-type-badge">Recipe</span>
                        <div class="import-preview-title" id="import-preview-title"></div>
                        <div class="import-preview-meta" id="import-preview-meta"></div>
                        <div class="import-preview-list" id="import-preview-list"></div>
                    </div>
                    <p class="text-muted" style="font-size: 0.85rem;">This will be added to your account. You can edit or delete it later.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="import-confirm-btn" onclick="confirmImport()" style="display: none;">Add to My Account</button>
            </div>
        </div>
    </div>

    <!-- Meal Plan Print Modal -->
    <div class="modal-overlay" id="planner-print-modal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h2 class="modal-title">Print Meal Plan</h2>
                <button class="modal-close" onclick="closePlannerPrintModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-2">Choose the layout to print:</p>
                <div class="print-options">
                    <div class="print-option-row">
                        <label class="form-checkbox">
                            <input type="radio" name="planner-print-view" value="week" checked>
                            <span><strong>Week view</strong> ‚Äî current week (Mon‚ÄìSun)</span>
                        </label>
                    </div>
                    <div class="print-option-row" style="margin-top: 0.5rem;">
                        <label class="form-checkbox">
                            <input type="radio" name="planner-print-view" value="month">
                            <span><strong>Month view</strong> ‚Äî current month</span>
                        </label>
                    </div>
                </div>
                <p class="text-muted" style="font-size: 0.85rem; margin-top: 0.75rem;">üí° Choose <strong>Landscape</strong> orientation in your browser's print dialog for the best result ‚Äî especially for the week view. Select "Save as PDF" to email or share the plan.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePlannerPrintModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="printMealPlan()">Print</button>
            </div>
        </div>
    </div>

    <!-- Print-only content (hidden on screen, shown when printing) -->
    <div class="print-header">
        <h1>üçΩ Shopping List</h1>
    </div>
    <div class="print-date" id="print-date"></div>
    <div class="print-shopping-content" id="print-shopping-content">
        <!-- Generated by JS for printing -->
    </div>

    <!-- Meal plan print-only content -->
    <div class="print-planner-content" id="print-planner-content">
        <div class="print-header"><h1>üçΩ Meal Plan</h1></div>
        <div class="print-date" id="print-planner-date"></div>
        <div id="print-planner-body"></div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // =====================
        // Firebase Setup
        // =====================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

		// Your Firebase configuration
				const firebaseConfig = {
					apiKey: "AIzaSyC95sD6h2ifQAFsRcbmWrJzQUjdpIFgINs",
					authDomain: "meal-planner-11865.firebaseapp.com",
					projectId: "meal-planner-11865",
					storageBucket: "meal-planner-11865.firebasestorage.app",
					messagingSenderId: "868044549043",
					appId: "1:868044549043:web:e37a748e457869621f39c6"
				};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // =====================
        // Data Management
        // =====================
        
        let recipes = [];
        let mealPlan = {};
        let shoppingHave = {};
        let adhocItems = [];
        let currentUser = null;
        let unsubscribeRecipes = null;
        let unsubscribeMealPlan = null;
        let unsubscribeShoppingHave = null;
        let unsubscribeAdhocItems = null;

        // Current state
        let currentWeekStart = getWeekStart(new Date());
        let currentViewingRecipeId = null;
        let currentMonth = new Date();
        let currentPlannerView = 'week'; // 'week' or 'month'
        let shoppingDateFrom = null;
        let shoppingDateTo = null;
        
        // Shops & Aisles
        let shops = [];
        let ingredientAisles = {}; // { "ingredient name": { "shopId": "aisleName" } }
        let currentShopId = null;
        let unsubscribeShops = null;
        let unsubscribeIngredientAisles = null;
        let editingShopId = null;
        
        // Meal Categories & Day Notes
        let mealCategories = ['Breakfast', 'Lunch', 'Dinner']; // Default categories
        let dayNotes = {}; // { "YYYY-MM-DD": "note text" }
        let unsubscribeSettings = null;

        // UI State
        let collapsedShops = {}; // { shopId: true } for collapsed aisle lists

        // =====================
        // Auth UI Functions
        // =====================

        function showAuthTab(tab) {
            document.getElementById('tab-signin').classList.toggle('active', tab === 'signin');
            document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
            document.getElementById('signin-form').classList.toggle('active', tab === 'signin');
            document.getElementById('signup-form').classList.toggle('active', tab === 'signup');
            hideAuthError();
        }
        window.showAuthTab = showAuthTab;

        function showAuthError(message) {
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
        }

        function hideAuthError() {
            document.getElementById('auth-error').classList.remove('visible');
        }

        async function handleSignIn(event) {
            event.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            const btn = document.getElementById('signin-btn');
            
            btn.disabled = true;
            btn.textContent = 'Signing in...';
            hideAuthError();
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAuthError(getAuthErrorMessage(error.code));
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }
        window.handleSignIn = handleSignIn;

        async function handleSignUp(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-password-confirm').value;
            const btn = document.getElementById('signup-btn');
            
            if (password !== confirmPassword) {
                showAuthError('Passwords do not match');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Creating account...';
            hideAuthError();
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAuthError(getAuthErrorMessage(error.code));
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }
        window.handleSignUp = handleSignUp;

        async function handleGoogleSignIn() {
            hideAuthError();
            try {
                // Try popup first (works on desktop)
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                console.error('Google sign-in error:', error);
                
                // If popup blocked or failed, try redirect method
                if (error.code === 'auth/popup-blocked' || 
                    error.code === 'auth/popup-closed-by-user' ||
                    error.code === 'auth/cancelled-popup-request') {
                    try {
                        // Use redirect method as fallback
                        await signInWithRedirect(auth, googleProvider);
                    } catch (redirectError) {
                        showAuthError(getAuthErrorMessage(redirectError.code));
                    }
                } else if (error.code === 'auth/unauthorized-domain') {
                    showAuthError('This domain is not authorized for Google Sign-In. Please use email/password, or add this domain in Firebase Console > Authentication > Settings > Authorized domains.');
                } else if (error.code !== 'auth/popup-closed-by-user') {
                    showAuthError(getAuthErrorMessage(error.code));
                }
            }
        }
        window.handleGoogleSignIn = handleGoogleSignIn;

        // Check for redirect result on page load
        getRedirectResult(auth).then((result) => {
            if (result && result.user) {
                // User signed in via redirect
                console.log('Signed in via redirect');
            }
        }).catch((error) => {
            if (error.code && error.code !== 'auth/popup-closed-by-user') {
                showAuthError(getAuthErrorMessage(error.code));
            }
        });

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }
        window.handleSignOut = handleSignOut;

        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/email-already-in-use':
                    return 'This email is already registered. Try signing in instead.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'Invalid email or password.';
                case 'auth/too-many-requests':
                    return 'Too many attempts. Please try again later.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }

        // =====================
        // Auth State Listener
        // =====================

        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-overlay').classList.add('hidden');
            
            if (user) {
                currentUser = user;
                showApp(user);
                setupDataListeners(user.uid);
                
                // Check for import link after a short delay to ensure data is loaded
                setTimeout(() => checkForImport(), 500);
                
                // Show welcome modal for new users
                setTimeout(() => checkShowWelcome(), 800);
            } else {
                currentUser = null;
                showAuthScreen();
                cleanupDataListeners();
            }
        });

        function showApp(user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.add('visible');
            
            // Update user info
            const email = user.email || 'User';
            document.getElementById('user-email').textContent = email;
            document.getElementById('user-avatar').textContent = email.charAt(0).toUpperCase();
        }

        function showAuthScreen() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-container').classList.remove('visible');
            
            // Reset forms
            document.getElementById('signin-form').reset();
            document.getElementById('signup-form').reset();
            document.getElementById('signin-btn').disabled = false;
            document.getElementById('signin-btn').textContent = 'Sign In';
            document.getElementById('signup-btn').disabled = false;
            document.getElementById('signup-btn').textContent = 'Create Account';
            hideAuthError();
        }

        // =====================
        // Data Listeners
        // =====================

        function setupDataListeners(userId) {
            // Clean up any existing listeners
            cleanupDataListeners();

            // Recipes listener
            unsubscribeRecipes = onSnapshot(
                collection(db, "users", userId, "recipes"),
                (snapshot) => {
                    recipes = [];
                    snapshot.forEach((doc) => {
                        recipes.push({ id: doc.id, ...doc.data() });
                    });
                    renderRecipes();
                    renderPlanner();
                    renderShoppingList();
                },
                (error) => {
                    console.error("Error listening to recipes:", error);
                    showSyncStatus('error', 'Sync error');
                }
            );

            // Meal plan listener
            unsubscribeMealPlan = onSnapshot(
                collection(db, "users", userId, "mealPlan"),
                (snapshot) => {
                    mealPlan = {};
                    snapshot.forEach((doc) => {
                        mealPlan[doc.id] = doc.data();
                    });
                    renderPlanner();
                    renderShoppingList();
                },
                (error) => {
                    console.error("Error listening to meal plan:", error);
                    showSyncStatus('error', 'Sync error');
                }
            );

            // Shopping "have" listener
            unsubscribeShoppingHave = onSnapshot(
                doc(db, "users", userId, "settings", "shoppingHave"),
                (snapshot) => {
                    if (snapshot.exists()) {
                        shoppingHave = snapshot.data();
                    } else {
                        shoppingHave = {};
                    }
                    renderShoppingList();
                },
                (error) => {
                    console.error("Error listening to shopping have:", error);
                }
            );

            // Ad-hoc items listener
            unsubscribeAdhocItems = onSnapshot(
                collection(db, "users", userId, "adhocItems"),
                (snapshot) => {
                    adhocItems = [];
                    snapshot.forEach((doc) => {
                        adhocItems.push({ id: doc.id, ...doc.data() });
                    });
                    renderShoppingList();
                },
                (error) => {
                    console.error("Error listening to adhoc items:", error);
                }
            );

            // Shops listener
            unsubscribeShops = onSnapshot(
                collection(db, "users", userId, "shops"),
                (snapshot) => {
                    shops = [];
                    snapshot.forEach((doc) => {
                        shops.push({ id: doc.id, ...doc.data() });
                    });
                    // Set current shop to default if not set
                    if (!currentShopId) {
                        const defaultShop = shops.find(s => s.isDefault);
                        currentShopId = defaultShop ? defaultShop.id : (shops[0]?.id || null);
                    }
                    renderShopsSettings();
                    updateShopSelector();
                    renderShoppingList();
                },
                (error) => {
                    console.error("Error listening to shops:", error);
                }
            );

            // Ingredient aisles listener
            unsubscribeIngredientAisles = onSnapshot(
                doc(db, "users", userId, "settings", "ingredientAisles"),
                (snapshot) => {
                    if (snapshot.exists()) {
                        ingredientAisles = snapshot.data();
                    } else {
                        ingredientAisles = {};
                    }
                    renderShoppingList();
                    renderIngredientDictionary();
                },
                (error) => {
                    console.error("Error listening to ingredient aisles:", error);
                }
            );
            
            // User settings listener (meal categories, day notes)
            unsubscribeSettings = onSnapshot(
                doc(db, "users", userId, "settings", "userPrefs"),
                (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        mealCategories = data.mealCategories || ['Breakfast', 'Lunch', 'Dinner'];
                        dayNotes = data.dayNotes || {};
                    } else {
                        mealCategories = ['Breakfast', 'Lunch', 'Dinner'];
                        dayNotes = {};
                    }
                    renderPlanner();
                    renderMealCategories();
                },
                (error) => {
                    console.error("Error listening to user settings:", error);
                }
            );
        }

        function cleanupDataListeners() {
            if (unsubscribeRecipes) unsubscribeRecipes();
            if (unsubscribeMealPlan) unsubscribeMealPlan();
            if (unsubscribeShoppingHave) unsubscribeShoppingHave();
            if (unsubscribeAdhocItems) unsubscribeAdhocItems();
            if (unsubscribeShops) unsubscribeShops();
            if (unsubscribeIngredientAisles) unsubscribeIngredientAisles();
            if (unsubscribeSettings) unsubscribeSettings();
            
            recipes = [];
            mealPlan = {};
            shoppingHave = {};
            adhocItems = [];
            shops = [];
            ingredientAisles = {};
            currentShopId = null;
            mealCategories = ['Breakfast', 'Lunch', 'Dinner'];
            dayNotes = {};
        }

        // =====================
        // Sync Status UI
        // =====================

        function showSyncStatus(status, text) {
            const statusEl = document.getElementById('sync-status');
            const dotEl = document.getElementById('sync-dot');
            const textEl = document.getElementById('sync-text');
            
            statusEl.classList.remove('hidden');
            dotEl.className = 'sync-dot';
            
            if (status === 'syncing') {
                dotEl.classList.add('syncing');
            } else if (status === 'error') {
                dotEl.classList.add('error');
            }
            
            textEl.textContent = text;
            
            // Auto-hide after 3 seconds for success
            if (status === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // =====================
        // Firebase Save Functions
        // =====================

        async function saveRecipeToFirebase(recipe) {
            if (!currentUser) return;
            showSyncStatus('syncing', 'Saving...');
            try {
                await setDoc(doc(db, "users", currentUser.uid, "recipes", recipe.id), {
                    name: recipe.name,
                    titleOnly: recipe.titleOnly,
                    ingredients: recipe.ingredients,
                    notes: recipe.notes
                });
                showSyncStatus('success', 'Saved');
            } catch (error) {
                console.error("Error saving recipe:", error);
                showSyncStatus('error', 'Save failed');
            }
        }

        async function deleteRecipeFromFirebase(recipeId) {
            if (!currentUser) return;
            showSyncStatus('syncing', 'Deleting...');
            try {
                await deleteDoc(doc(db, "users", currentUser.uid, "recipes", recipeId));
                showSyncStatus('success', 'Deleted');
            } catch (error) {
                console.error("Error deleting recipe:", error);
                showSyncStatus('error', 'Delete failed');
            }
        }

        async function saveMealPlanToFirebase(date, meals) {
            if (!currentUser) return;
            showSyncStatus('syncing', 'Saving...');
            try {
                if (Object.keys(meals).length === 0) {
                    await deleteDoc(doc(db, "users", currentUser.uid, "mealPlan", date));
                } else {
                    await setDoc(doc(db, "users", currentUser.uid, "mealPlan", date), meals);
                }
                showSyncStatus('success', 'Saved');
            } catch (error) {
                console.error("Error saving meal plan:", error);
                showSyncStatus('error', 'Save failed');
            }
        }

        async function saveShoppingHaveToFirebase() {
            if (!currentUser) return;
            try {
                await setDoc(doc(db, "users", currentUser.uid, "settings", "shoppingHave"), shoppingHave);
            } catch (error) {
                console.error("Error saving shopping have:", error);
            }
        }

        // =====================
        // Utility Functions
        // =====================

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }

        function isDateInPast(date) {
            return date < getToday();
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDisplayDate(date) {
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        function formatUKLongDate(date) {
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatWeekDisplay(weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            return `${formatDisplayDate(weekStart)} - ${formatDisplayDate(weekEnd)}`;
        }

        function getDayName(date) {
            return date.toLocaleDateString('en-GB', { weekday: 'long' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =====================
        // Navigation
        // =====================

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                
                // Update nav buttons
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(`${view}-view`).classList.add('active');
                
                // Refresh view data
                if (view === 'recipes') renderRecipes();
                if (view === 'planner') renderPlanner();
                if (view === 'shopping') renderShoppingList();
            });
        });

        // =====================
        // Recipe Management
        // =====================

        function renderRecipes() {
            const grid = document.getElementById('recipes-grid');
            const empty = document.getElementById('recipes-empty');
            const searchTerm = document.getElementById('recipe-search').value.toLowerCase();
            
            const filtered = recipes.filter(r => 
                r.name.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            grid.innerHTML = filtered.map(recipe => `
                <div class="recipe-card" onclick="viewRecipe('${recipe.id}')">
                    ${recipe.titleOnly ? '<span class="recipe-card-badge">Title Only</span>' : ''}
                    <h3 class="recipe-card-title">${escapeHtml(recipe.name)}</h3>
                    <p class="recipe-card-meta">
                        ${recipe.titleOnly ? 'No ingredients' : `${recipe.ingredients.length} ingredient${recipe.ingredients.length !== 1 ? 's' : ''}`}
                    </p>
                </div>
            `).join('');
        }
        window.renderRecipes = renderRecipes;

        function filterRecipes() {
            renderRecipes();
        }
        window.filterRecipes = filterRecipes;

        function openAddRecipeModal() {
            document.getElementById('recipe-modal-title').textContent = 'Add Recipe';
            document.getElementById('recipe-form').reset();
            document.getElementById('recipe-id').value = '';
            document.getElementById('recipe-title-only').checked = false;
            document.getElementById('bulk-ingredients').value = '';
            toggleIngredientsSection();
            showIngredientMode('single');
            
            // Clear and add one empty ingredient input
            const list = document.getElementById('ingredients-list');
            list.innerHTML = '';
            addIngredientInput();
            
            document.getElementById('recipe-modal').classList.add('active');
        }
        window.openAddRecipeModal = openAddRecipeModal;

        function closeRecipeModal() {
            document.getElementById('recipe-modal').classList.remove('active');
        }
        window.closeRecipeModal = closeRecipeModal;

        function toggleIngredientsSection() {
            const titleOnly = document.getElementById('recipe-title-only').checked;
            document.getElementById('ingredients-section').style.display = titleOnly ? 'none' : 'block';
        }
        window.toggleIngredientsSection = toggleIngredientsSection;

        function addIngredientInput(ingredient = null) {
            // ingredient can be: string (legacy), object {name, quantity}, or null
            let name = '';
            let quantity = '';
            
            if (typeof ingredient === 'string') {
                name = ingredient; // Legacy format - whole string goes to name
            } else if (ingredient && typeof ingredient === 'object') {
                name = ingredient.name || '';
                quantity = ingredient.quantity || '';
            }
            
            const list = document.getElementById('ingredients-list');
            const li = document.createElement('li');
            li.className = 'ingredient-item';
            const inputId = 'ing-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            li.innerHTML = `
                <input type="text" class="ingredient-qty-input" value="${escapeHtml(quantity)}" placeholder="Qty">
                <div class="ingredient-name-wrapper">
                    <input type="text" class="ingredient-name-input" id="${inputId}" value="${escapeHtml(name)}" placeholder="Ingredient name" oninput="showIngredientAutocomplete(this)" onkeydown="handleAutocompleteKeydown(event, this)" onblur="hideIngredientAutocomplete(this)">
                </div>
                <button type="button" class="ingredient-remove" onclick="removeIngredientInput(this)">&times;</button>
            `;
            list.appendChild(li);
            
            // Focus the name input
            li.querySelector('.ingredient-name-input').focus();
        }
        window.addIngredientInput = addIngredientInput;

        // Get all unique ingredient names across all recipes
        function getAllIngredientNames() {
            const names = new Set();
            recipes.forEach(recipe => {
                if (recipe.ingredients) {
                    recipe.ingredients.forEach(ing => {
                        // Handle both old string format and new object format
                        if (typeof ing === 'string') {
                            names.add(ing.toLowerCase().trim());
                        } else if (ing && ing.name) {
                            names.add(ing.name.toLowerCase().trim());
                        }
                    });
                }
            });
            return Array.from(names).sort();
        }

        let autocompleteHighlightIndex = -1;

        function showIngredientAutocomplete(input) {
            const value = input.value.toLowerCase().trim();
            const wrapper = input.parentElement;
            
            // Remove existing dropdown
            const existing = wrapper.querySelector('.autocomplete-dropdown');
            if (existing) existing.remove();
            
            if (value.length < 2) return;
            
            const allNames = getAllIngredientNames();
            const matches = allNames.filter(name => 
                name.includes(value) && name !== value
            ).slice(0, 8);
            
            if (matches.length === 0) return;
            
            const dropdown = document.createElement('div');
            dropdown.className = 'autocomplete-dropdown';
            
            matches.forEach((name, index) => {
                const aisle = getIngredientAisle(name, currentShopId);
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `${escapeHtml(name)}${aisle ? `<span class="autocomplete-aisle">(${escapeHtml(aisle)})</span>` : ''}`;
                item.onmousedown = (e) => {
                    e.preventDefault();
                    selectAutocompleteItem(input, name);
                };
                dropdown.appendChild(item);
            });
            
            wrapper.appendChild(dropdown);
            autocompleteHighlightIndex = -1;
        }
        window.showIngredientAutocomplete = showIngredientAutocomplete;

        function hideIngredientAutocomplete(input) {
            setTimeout(() => {
                const wrapper = input.parentElement;
                const dropdown = wrapper.querySelector('.autocomplete-dropdown');
                if (dropdown) dropdown.remove();
            }, 150);
        }
        window.hideIngredientAutocomplete = hideIngredientAutocomplete;

        function handleAutocompleteKeydown(event, input) {
            const wrapper = input.parentElement;
            const dropdown = wrapper.querySelector('.autocomplete-dropdown');
            
            if (!dropdown) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item');
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                autocompleteHighlightIndex = Math.min(autocompleteHighlightIndex + 1, items.length - 1);
                updateAutocompleteHighlight(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                autocompleteHighlightIndex = Math.max(autocompleteHighlightIndex - 1, -1);
                updateAutocompleteHighlight(items);
            } else if (event.key === 'Enter' && autocompleteHighlightIndex >= 0) {
                event.preventDefault();
                const selectedItem = items[autocompleteHighlightIndex];
                if (selectedItem) {
                    const name = selectedItem.textContent.split('(')[0].trim();
                    selectAutocompleteItem(input, name);
                }
            } else if (event.key === 'Escape') {
                dropdown.remove();
            }
        }
        window.handleAutocompleteKeydown = handleAutocompleteKeydown;

        function updateAutocompleteHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === autocompleteHighlightIndex);
            });
        }

        function selectAutocompleteItem(input, name) {
            input.value = name;
            const wrapper = input.parentElement;
            const dropdown = wrapper.querySelector('.autocomplete-dropdown');
            if (dropdown) dropdown.remove();
            
            // Move focus to next ingredient or add new one
            const li = input.closest('.ingredient-item');
            const nextLi = li.nextElementSibling;
            if (nextLi) {
                nextLi.querySelector('.ingredient-name-input').focus();
            }
        }

        function removeIngredientInput(btn) {
            const list = document.getElementById('ingredients-list');
            btn.parentElement.remove();
            
            // Always keep at least one input
            if (list.children.length === 0) {
                addIngredientInput();
            }
        }
        window.removeIngredientInput = removeIngredientInput;

        function showIngredientMode(mode) {
            const singleMode = document.getElementById('single-ingredient-mode');
            const bulkMode = document.getElementById('bulk-ingredient-mode');
            const toggleSingle = document.getElementById('toggle-single');
            const toggleBulk = document.getElementById('toggle-bulk');
            
            if (mode === 'single') {
                singleMode.style.display = 'block';
                bulkMode.style.display = 'none';
                toggleSingle.classList.add('active');
                toggleBulk.classList.remove('active');
            } else {
                singleMode.style.display = 'none';
                bulkMode.style.display = 'block';
                toggleSingle.classList.remove('active');
                toggleBulk.classList.add('active');
                
                // Pre-populate bulk textarea with existing ingredient names
                const nameInputs = document.querySelectorAll('#ingredients-list .ingredient-name-input');
                const existing = Array.from(nameInputs)
                    .map(input => input.value.trim())
                    .filter(val => val.length > 0);
                document.getElementById('bulk-ingredients').value = existing.join('\n');
            }
        }
        window.showIngredientMode = showIngredientMode;

        function applyBulkIngredients() {
            const bulkText = document.getElementById('bulk-ingredients').value;
            const ingredients = bulkText
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // Clear existing ingredients list
            const list = document.getElementById('ingredients-list');
            list.innerHTML = '';
            
            // Add each ingredient (as name only, no quantity)
            if (ingredients.length > 0) {
                ingredients.forEach(ing => addIngredientInput({ name: ing, quantity: '' }));
            } else {
                addIngredientInput();
            }
            
            // Switch back to single mode to show the result
            showIngredientMode('single');
        }
        window.applyBulkIngredients = applyBulkIngredients;

        async function saveRecipe(event) {
            event.preventDefault();
            
            const id = document.getElementById('recipe-id').value || generateId();
            const name = document.getElementById('recipe-name').value.trim();
            const titleOnly = document.getElementById('recipe-title-only').checked;
            const notes = document.getElementById('recipe-notes').value.trim();
            
            let ingredients = [];
            if (!titleOnly) {
                const items = document.querySelectorAll('#ingredients-list .ingredient-item');
                items.forEach(item => {
                    const qtyInput = item.querySelector('.ingredient-qty-input');
                    const nameInput = item.querySelector('.ingredient-name-input');
                    const ingredientName = nameInput?.value.trim() || '';
                    const quantity = qtyInput?.value.trim() || '';
                    
                    if (ingredientName) {
                        ingredients.push({ name: ingredientName, quantity: quantity });
                    }
                });
            }
            
            const recipe = { id, name, titleOnly, ingredients, notes };
            
            await saveRecipeToFirebase(recipe);
            closeRecipeModal();
        }
        window.saveRecipe = saveRecipe;

        function viewRecipe(id) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;
            
            currentViewingRecipeId = id;
            
            document.getElementById('view-recipe-title').textContent = recipe.name;
            
            let html = '';
            
            if (recipe.titleOnly) {
                html += '<p class="text-muted"><em>This is a title-only recipe (no ingredients tracked)</em></p>';
            } else if (recipe.ingredients && recipe.ingredients.length > 0) {
                html += '<h4 class="mb-1">Ingredients</h4><ul>';
                recipe.ingredients.forEach(ing => {
                    // Handle both old string format and new object format
                    if (typeof ing === 'string') {
                        html += `<li>${escapeHtml(ing)}</li>`;
                    } else if (ing && ing.name) {
                        const display = ing.quantity 
                            ? `${escapeHtml(ing.quantity)} √ó ${escapeHtml(ing.name)}`
                            : escapeHtml(ing.name);
                        html += `<li>${display}</li>`;
                    }
                });
                html += '</ul>';
            }
            
            if (recipe.notes) {
                html += `<h4 class="mt-2 mb-1">Notes</h4><p>${escapeHtml(recipe.notes).replace(/\n/g, '<br>')}</p>`;
            }
            
            document.getElementById('view-recipe-body').innerHTML = html;
            document.getElementById('view-recipe-modal').classList.add('active');
        }
        window.viewRecipe = viewRecipe;

        function closeViewRecipeModal() {
            document.getElementById('view-recipe-modal').classList.remove('active');
            currentViewingRecipeId = null;
        }
        window.closeViewRecipeModal = closeViewRecipeModal;

        function editCurrentRecipe() {
            const recipe = recipes.find(r => r.id === currentViewingRecipeId);
            if (!recipe) return;
            
            closeViewRecipeModal();
            
            document.getElementById('recipe-modal-title').textContent = 'Edit Recipe';
            document.getElementById('recipe-id').value = recipe.id;
            document.getElementById('recipe-name').value = recipe.name;
            document.getElementById('recipe-title-only').checked = recipe.titleOnly;
            document.getElementById('recipe-notes').value = recipe.notes || '';
            document.getElementById('bulk-ingredients').value = '';
            
            toggleIngredientsSection();
            showIngredientMode('single');
            
            const list = document.getElementById('ingredients-list');
            list.innerHTML = '';
            
            if (recipe.ingredients.length > 0) {
                recipe.ingredients.forEach(ing => addIngredientInput(ing));
            } else {
                addIngredientInput();
            }
            
            document.getElementById('recipe-modal').classList.add('active');
        }
        window.editCurrentRecipe = editCurrentRecipe;

        async function deleteCurrentRecipe() {
            if (!confirm('Are you sure you want to delete this recipe? It will also be removed from any meal plans.')) {
                return;
            }
            
            const recipeId = currentViewingRecipeId;
            
            // Remove from Firebase recipes
            await deleteRecipeFromFirebase(recipeId);
            
            // Remove from meal plans
            for (const date in mealPlan) {
                let changed = false;
                for (const meal in mealPlan[date]) {
                    if (mealPlan[date][meal] === recipeId) {
                        delete mealPlan[date][meal];
                        changed = true;
                    }
                }
                if (changed) {
                    await saveMealPlanToFirebase(date, mealPlan[date]);
                }
            }
            
            closeViewRecipeModal();
        }
        window.deleteCurrentRecipe = deleteCurrentRecipe;

        // =====================
        // Meal Planner
        // =====================

        function getMealTypes() {
            return mealCategories.length > 0 ? mealCategories : ['Breakfast', 'Lunch', 'Dinner'];
        }

        function renderPlanner() {
            document.getElementById('week-display').textContent = formatWeekDisplay(currentWeekStart);
            
            const container = document.getElementById('planner-week');
            const today = getToday();
            let html = '';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dateStr = formatDate(date);
                const dayMeals = mealPlan[dateStr] || {};
                const note = dayNotes[dateStr] || '';
                
                // Determine day state
                const isPast = date < today;
                const isToday = date.getTime() === today.getTime();
                const dayClass = isPast ? 'past' : (isToday ? 'today' : '');
                
                html += `
                    <div class="day-card ${dayClass}">
                        <div class="day-header">
                            ${getDayName(date)}${isToday ? ' (Today)' : ''}
                            <div class="date">${formatDisplayDate(date)}</div>
                        </div>
                        <div class="day-meals">
                            ${getMealTypes().map(meal => {
                                const mealKey = meal.toLowerCase().replace(/[^a-z0-9]/g, '_');
                                // Check multiple possible key formats for backwards compatibility
                                const recipeId = dayMeals[mealKey] || dayMeals[meal] || dayMeals[meal.toLowerCase()];
                                const recipe = recipeId ? recipes.find(r => r.id === recipeId) : null;
                                
                                return `
                                    <div class="meal-slot">
                                        <div>
                                            <div class="meal-slot-label">${escapeHtml(meal)}</div>
                                            ${recipe 
                                                ? `<div class="meal-slot-name">${escapeHtml(recipe.name)}</div>`
                                                : `<div class="meal-slot-empty">Not planned</div>`
                                            }
                                        </div>
                                        <div class="meal-slot-actions">
                                            <button class="meal-slot-btn" onclick="openSelectRecipeModal('${dateStr}', '${escapeHtml(mealKey)}')" title="Add/Change">
                                                ${recipe ? '‚úèÔ∏è' : '‚ûï'}
                                            </button>
                                            ${recipe ? `
                                                <button class="meal-slot-btn remove" onclick="removeMeal('${dateStr}', '${escapeHtml(mealKey)}')" title="Remove">
                                                    ‚úï
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="day-notes">
                            ${note 
                                ? `<div class="day-notes-preview" onclick="toggleDayNotes('${dateStr}')">${escapeHtml(note.substring(0, 50))}${note.length > 50 ? '...' : ''} <span style="color: var(--accent-green);">‚úèÔ∏è</span></div>`
                                : `<div class="day-notes-toggle" onclick="toggleDayNotes('${dateStr}')">üìù Add note</div>`
                            }
                            <div id="notes-editor-${dateStr}" style="display: none;">
                                <textarea class="day-notes-input" id="notes-input-${dateStr}" placeholder="Add a note for this day..." onblur="saveDayNote('${dateStr}')">${escapeHtml(note)}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        window.renderPlanner = renderPlanner;

        function changeWeek(direction) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            renderPlanner();
            renderShoppingList();
        }
        window.changeWeek = changeWeek;

        // =====================
        // Month View Functions
        // =====================

        function showPlannerView(view) {
            currentPlannerView = view;
            
            document.getElementById('week-view-btn').classList.toggle('active', view === 'week');
            document.getElementById('month-view-btn').classList.toggle('active', view === 'month');
            document.getElementById('week-view-container').style.display = view === 'week' ? 'block' : 'none';
            document.getElementById('month-view-container').style.display = view === 'month' ? 'block' : 'none';
            
            if (view === 'month') {
                renderMonthView();
            }
        }
        window.showPlannerView = showPlannerView;

        function changeMonth(direction) {
            currentMonth.setMonth(currentMonth.getMonth() + direction);
            renderMonthView();
        }
        window.changeMonth = changeMonth;

        function renderMonthView() {
            const container = document.getElementById('planner-month');
            const monthDisplay = document.getElementById('month-display');
            const today = getToday();
            
            // Set month display
            const monthName = currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            monthDisplay.textContent = monthName;
            
            // Get first day of month and calculate grid
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Calculate start of grid (Monday before or on first day)
            const startDate = new Date(firstDay);
            const dayOfWeek = firstDay.getDay();
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0 offset
            startDate.setDate(startDate.getDate() - daysToSubtract);
            
            let html = '';
            
            // Header row
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayNames.forEach(day => {
                html += `<div class="month-header-cell">${day}</div>`;
            });
            
            // Day cells (6 weeks max)
            const currentDate = new Date(startDate);
            for (let i = 0; i < 42; i++) {
                const dateStr = formatDate(currentDate);
                const dayMeals = mealPlan[dateStr] || {};
                const isOtherMonth = currentDate.getMonth() !== month;
                const isPast = currentDate < today;
                const isToday = currentDate.getTime() === today.getTime();
                
                let classes = 'month-day';
                if (isOtherMonth) classes += ' other-month';
                if (isPast && !isOtherMonth) classes += ' past';
                if (isToday) classes += ' today';
                
                // Get meals for this day (use same key lookup as renderPlanner for compatibility)
                const meals = [];
                getMealTypes().forEach(mealType => {
                    const mealKey = mealType.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    const recipeId = dayMeals[mealKey] || dayMeals[mealType] || dayMeals[mealType.toLowerCase()];
                    if (recipeId) {
                        const recipe = recipes.find(r => r.id === recipeId);
                        if (recipe) {
                            meals.push({ type: mealKey, label: mealType, name: recipe.name });
                        }
                    }
                });

                html += `
                    <div class="${classes}" onclick="jumpToDate('${dateStr}')">
                        <div class="month-day-number">${currentDate.getDate()}</div>
                        <div class="month-day-meals">
                            ${meals.slice(0, 3).map(m => `
                                <div class="month-meal-pill ${m.type}"><span class="pill-initial">${escapeHtml(m.label[0])}</span> ${escapeHtml(m.name)}</div>
                            `).join('')}
                            ${meals.length > 3 ? `<div class="month-day-more">+${meals.length - 3} more</div>` : ''}
                        </div>
                    </div>
                `;
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            container.innerHTML = html;
        }
        window.renderMonthView = renderMonthView;

        function jumpToDate(dateStr) {
            // Switch to week view and navigate to the week containing this date
            const date = new Date(dateStr);
            currentWeekStart = getWeekStart(date);
            showPlannerView('week');
            renderPlanner();
        }
        window.jumpToDate = jumpToDate;

        function openSelectRecipeModal(date, meal) {
            document.getElementById('select-recipe-date').value = date;
            document.getElementById('select-recipe-meal').value = meal;
            document.getElementById('select-recipe-search').value = '';
            document.getElementById('quick-add-recipe-form').style.display = 'none';
            document.getElementById('quick-recipe-name').value = '';
            document.getElementById('quick-recipe-title-only').checked = false;

            renderRecipeSelectList();
            document.getElementById('select-recipe-modal').classList.add('active');
        }
        window.openSelectRecipeModal = openSelectRecipeModal;

        function closeSelectRecipeModal() {
            document.getElementById('select-recipe-modal').classList.remove('active');
        }
        window.closeSelectRecipeModal = closeSelectRecipeModal;

        function renderRecipeSelectList() {
            const searchTerm = document.getElementById('select-recipe-search').value.toLowerCase();
            const list = document.getElementById('recipe-select-list');
            
            const filtered = recipes.filter(r => 
                r.name.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>No recipes found. Add some recipes first!</p></div>';
                return;
            }
            
            list.innerHTML = filtered.map(recipe => `
                <div class="recipe-select-item" onclick="selectRecipeForMeal('${recipe.id}')">
                    <strong>${escapeHtml(recipe.name)}</strong>
                    ${recipe.titleOnly ? ' <span class="text-muted">(title only)</span>' : ''}
                </div>
            `).join('');
        }
        window.renderRecipeSelectList = renderRecipeSelectList;

        function filterRecipeSelect() {
            renderRecipeSelectList();
        }
        window.filterRecipeSelect = filterRecipeSelect;

        async function selectRecipeForMeal(recipeId) {
            const date = document.getElementById('select-recipe-date').value;
            const meal = document.getElementById('select-recipe-meal').value;

            if (!mealPlan[date]) {
                mealPlan[date] = {};
            }
            mealPlan[date][meal] = recipeId;

            await saveMealPlanToFirebase(date, mealPlan[date]);
            closeSelectRecipeModal();
        }
        window.selectRecipeForMeal = selectRecipeForMeal;

        function toggleQuickAddRecipeForm() {
            const form = document.getElementById('quick-add-recipe-form');
            const isVisible = form.style.display !== 'none';
            form.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                setTimeout(() => document.getElementById('quick-recipe-name').focus(), 50);
            }
        }
        window.toggleQuickAddRecipeForm = toggleQuickAddRecipeForm;

        async function saveQuickRecipeForMeal() {
            const nameInput = document.getElementById('quick-recipe-name');
            const name = nameInput.value.trim();
            if (!name) {
                nameInput.focus();
                return;
            }

            const titleOnly = document.getElementById('quick-recipe-title-only').checked;
            const id = generateId();
            const recipe = { id, name, titleOnly, ingredients: [], notes: '' };

            await saveRecipeToFirebase(recipe);

            // Hide form and auto-select the new recipe
            document.getElementById('quick-add-recipe-form').style.display = 'none';
            await selectRecipeForMeal(id);
        }
        window.saveQuickRecipeForMeal = saveQuickRecipeForMeal;

        async function removeMeal(date, meal) {
            if (mealPlan[date] && mealPlan[date][meal]) {
                delete mealPlan[date][meal];
                await saveMealPlanToFirebase(date, mealPlan[date]);
            }
        }
        window.removeMeal = removeMeal;

        // =====================
        // Shopping List
        // =====================

        function renderShoppingList() {
            const container = document.getElementById('shopping-list');
            const empty = document.getElementById('shopping-empty');
            const summary = document.getElementById('shopping-summary');
            const sortSelect = document.getElementById('sort-select');
            const printDateEl = document.getElementById('print-date');
            
            // Get all ingredients from meal plan within date range
            const ingredients = [];
            
            // Loop through all dates in the mealPlan
            Object.keys(mealPlan).forEach(dateStr => {
                const date = new Date(dateStr);
                
                // Apply date range filter
                if (!shouldIncludeDateInRange(date)) return;
                
                const dayName = getDayName(date);
                const dayMeals = mealPlan[dateStr] || {};
                const dayIndex = date.getTime(); // Use timestamp for sorting
                
                // Iterate over actual meals in the plan (handles both old and new key formats)
                for (const mealKey in dayMeals) {
                    const recipeId = dayMeals[mealKey];
                    if (!recipeId) continue;
                    
                    const recipe = recipes.find(r => r.id === recipeId);
                    if (!recipe || recipe.titleOnly || !recipe.ingredients) continue;
                    
                    recipe.ingredients.forEach(ing => {
                        // Handle both old string format and new object format
                        let ingredientName, quantity, displayText;
                        if (typeof ing === 'string') {
                            ingredientName = ing;
                            quantity = '';
                            displayText = ing;
                        } else if (ing && ing.name) {
                            ingredientName = ing.name;
                            quantity = ing.quantity || '';
                            displayText = quantity ? `${quantity} √ó ${ing.name}` : ing.name;
                        } else {
                            return; // Skip invalid entries
                        }
                        
                        const uniqueKey = `${dateStr}_${mealKey}_${recipe.id}_${ingredientName.toLowerCase()}`;
                        ingredients.push({
                            text: displayText,
                            ingredientName: ingredientName, // For aisle lookup
                            quantity: quantity,
                            recipeName: recipe.name,
                            dayName: dayName,
                            dateDisplay: formatUKLongDate(date),
                            meal: mealKey,
                            dateStr: dateStr,
                            dayIndex: dayIndex,
                            key: uniqueKey,
                            isAdhoc: false
                        });
                    });
                }
            });
            
            // Add ad-hoc items
            adhocItems.forEach(item => {
                ingredients.push({
                    text: item.text,
                    recipeName: 'Extra item',
                    dayName: '',
                    meal: '',
                    dateStr: '',
                    dayIndex: 999, // Sort to end when sorting by day
                    key: `adhoc_${item.id}`,
                    isAdhoc: true,
                    adhocId: item.id
                });
            });
            
            if (ingredients.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                summary.style.display = 'none';
                return;
            }
            
            empty.style.display = 'none';
            summary.style.display = 'flex';
            
            // Sort based on selection
            const sortMethod = sortSelect ? sortSelect.value : 'alpha';
            let sortedIngredients;
            
            // Get current shop for aisle sorting
            const currentShop = shops.find(s => s.id === currentShopId);
            const shopAisles = currentShop?.aisles || [];
            
            // Add aisle info to each ingredient
            ingredients.forEach(ing => {
                // Use ingredientName for aisle lookup (falls back to text for adhoc items)
                const lookupName = ing.ingredientName || ing.text;
                ing.aisle = getIngredientAisle(lookupName, currentShopId);
                ing.aisleOrder = shopAisles.findIndex(a => a.name === ing.aisle);
                if (ing.aisleOrder === -1) ing.aisleOrder = 9999; // Uncategorised at end
            });
            
            switch (sortMethod) {
                case 'aisle':
                    sortedIngredients = ingredients.sort((a, b) => {
                        if (a.aisleOrder !== b.aisleOrder) return a.aisleOrder - b.aisleOrder;
                        return a.text.localeCompare(b.text);
                    });
                    break;
                case 'day':
                    sortedIngredients = ingredients.sort((a, b) => {
                        if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                        return a.text.localeCompare(b.text);
                    });
                    break;
                case 'recipe':
                    sortedIngredients = ingredients.sort((a, b) => {
                        if (a.recipeName !== b.recipeName) return a.recipeName.localeCompare(b.recipeName);
                        return a.text.localeCompare(b.text);
                    });
                    break;
                default: // 'alpha'
                    sortedIngredients = ingredients.sort((a, b) => 
                        a.text.localeCompare(b.text)
                    );
            }
            
            // Calculate summary
            const total = sortedIngredients.length;
            const haveCount = sortedIngredients.filter(ing => shoppingHave[ing.key]).length;
            const needCount = total - haveCount;
            
            // Update print date
            if (printDateEl) {
                printDateEl.textContent = `${formatDisplayDate(shoppingDateFrom)} - ${formatDisplayDate(shoppingDateTo)} ‚Ä¢ Printed ${new Date().toLocaleDateString('en-GB')}`;
            }
            
            summary.innerHTML = `
                <div class="shopping-summary-stat">
                    <div class="shopping-summary-number">${total}</div>
                    <div class="shopping-summary-label">Total Items</div>
                </div>
                <div class="shopping-summary-stat">
                    <div class="shopping-summary-number">${haveCount}</div>
                    <div class="shopping-summary-label">Already Have</div>
                </div>
                <div class="shopping-summary-stat">
                    <div class="shopping-summary-number">${needCount}</div>
                    <div class="shopping-summary-label">Need to Buy</div>
                </div>
            `;
            
            // Render list
            const needItems = sortedIngredients.filter(ing => !shoppingHave[ing.key]);
            const haveItems = sortedIngredients.filter(ing => shoppingHave[ing.key]);
            
            let html = '';
            
            if (needItems.length > 0) {
                if (sortMethod === 'aisle' && currentShopId && shopAisles.length > 0) {
                    // Group by aisle
                    html += '<div class="shopping-section">';
                    html += '<h3 class="shopping-section-title">üõí Need to Buy</h3>';
                    
                    // Group items by aisle
                    const aisleGroups = {};
                    needItems.forEach(ing => {
                        const aisleName = ing.aisle || '__uncategorised__';
                        if (!aisleGroups[aisleName]) {
                            aisleGroups[aisleName] = [];
                        }
                        aisleGroups[aisleName].push(ing);
                    });
                    
                    // Render in aisle order
                    shopAisles.forEach((aisle, index) => {
                        const items = aisleGroups[aisle.name];
                        if (items && items.length > 0) {
                            html += `<div class="aisle-section">`;
                            html += `<div class="aisle-section-title"><span class="aisle-section-order">${index + 1}</span> ${escapeHtml(aisle.name)}</div>`;
                            items.forEach(ing => {
                                html += renderShoppingItem(ing, false, sortMethod);
                            });
                            html += '</div>';
                        }
                    });
                    
                    // Uncategorised at the end
                    const uncategorised = aisleGroups['__uncategorised__'];
                    if (uncategorised && uncategorised.length > 0) {
                        html += `<div class="aisle-section">`;
                        html += `<div class="aisle-section-title" style="background: var(--bg-cream); color: var(--text-secondary);">üì¶ Uncategorised</div>`;
                        uncategorised.forEach(ing => {
                            html += renderShoppingItem(ing, false, sortMethod);
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                } else {
                    html += '<div class="shopping-section">';
                    html += '<h3 class="shopping-section-title">üõí Need to Buy</h3>';
                    needItems.forEach(ing => {
                        html += renderShoppingItem(ing, false, sortMethod);
                    });
                    html += '</div>';
                }
            }
            
            if (haveItems.length > 0) {
                html += '<div class="shopping-section shopping-section-have">';
                html += '<h3 class="shopping-section-title">‚úì Already Have</h3>';
                haveItems.forEach(ing => {
                    html += renderShoppingItem(ing, true, sortMethod);
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        window.renderShoppingList = renderShoppingList;

        function renderShoppingItem(ing, have, sortMethod = 'alpha') {
            const escapedKey = ing.key.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const isAdhoc = ing.isAdhoc;
            const adhocClass = isAdhoc ? 'adhoc' : '';
            const contextText = isAdhoc ? 'Extra item' : `${escapeHtml(ing.dateDisplay || ing.dayName)} ¬∑ ${escapeHtml(ing.recipeName)}`;
            
            // Show set aisle button if sorting by aisle and item has no aisle
            const showSetAisle = sortMethod === 'aisle' && !ing.aisle && currentShopId && shops.find(s => s.id === currentShopId)?.aisles?.length > 0;
            const escapedText = escapeHtml(ing.text).replace(/'/g, "\\'");
            
            return `
                <div class="shopping-item ${have ? 'have' : ''} ${adhocClass}">
                    <input type="checkbox" 
                           ${have ? 'checked' : ''} 
                           onchange="toggleShoppingItem('${escapedKey}', this.checked)">
                    <div class="shopping-item-text">
                        ${escapeHtml(ing.text)}
                        <div class="shopping-item-recipe">${contextText}</div>
                    </div>
                    ${showSetAisle ? `<button class="set-aisle-btn" onclick="showAisleSelector('${escapedText}', this)">Set aisle</button>` : ''}
                    ${isAdhoc ? `<button class="shopping-item-remove" onclick="removeAdhocItem('${ing.adhocId}')" title="Remove item">‚úï</button>` : ''}
                </div>
            `;
        }

        async function toggleShoppingItem(key, have) {
            if (have) {
                shoppingHave[key] = true;
            } else {
                delete shoppingHave[key];
            }
            await saveShoppingHaveToFirebase();
            renderShoppingList();
        }
        window.toggleShoppingItem = toggleShoppingItem;

        async function clearHaveItems() {
            if (!confirm('Uncheck all items? This will reset your shopping list progress.')) return;
            
            shoppingHave = {};
            await saveShoppingHaveToFirebase();
            renderShoppingList();
        }
        window.clearHaveItems = clearHaveItems;

        function printShoppingList() {
            const hideChecked = document.getElementById('print-hide-checked').checked;
            const printContent = document.getElementById('print-shopping-content');
            const printDateEl = document.getElementById('print-date');
            
            // Get current shop for aisle info
            const currentShop = shops.find(s => s.id === currentShopId);
            const shopAisles = currentShop?.aisles || [];
            const sortMethod = document.getElementById('sort-select')?.value || 'alpha';
            
            // Get all items that need to be bought (not checked)
            const items = [];
            
            Object.keys(mealPlan).forEach(dateStr => {
                const date = new Date(dateStr);
                if (!shouldIncludeDateInRange(date)) return;
                
                const dayName = getDayName(date);
                const dayMeals = mealPlan[dateStr] || {};
                
                // Iterate over actual meals in the plan
                for (const mealKey in dayMeals) {
                    const recipeId = dayMeals[mealKey];
                    if (!recipeId) continue;
                    
                    const recipe = recipes.find(r => r.id === recipeId);
                    if (!recipe || recipe.titleOnly || !recipe.ingredients) continue;
                    
                    recipe.ingredients.forEach(ing => {
                        // Handle both old string format and new object format
                        let ingredientName, displayText;
                        if (typeof ing === 'string') {
                            ingredientName = ing;
                            displayText = ing;
                        } else if (ing && ing.name) {
                            ingredientName = ing.name;
                            displayText = ing.quantity ? `${ing.quantity} √ó ${ing.name}` : ing.name;
                        } else {
                            return;
                        }
                        
                        const uniqueKey = `${dateStr}_${mealKey}_${recipe.id}_${ingredientName.toLowerCase()}`;
                        
                        // Skip if already have (when hideChecked is true)
                        if (hideChecked && shoppingHave[uniqueKey]) return;
                        
                        const aisle = getIngredientAisle(ingredientName, currentShopId);
                        const aisleOrder = shopAisles.findIndex(a => a.name === aisle);
                        
                        items.push({
                            text: displayText,
                            context: `${formatUKLongDate(date)} ¬∑ ${recipe.name}`,
                            aisle: aisle,
                            aisleOrder: aisleOrder === -1 ? 9999 : aisleOrder,
                            have: !!shoppingHave[uniqueKey]
                        });
                    });
                }
            });
            
            // Add ad-hoc items
            adhocItems.forEach(item => {
                const key = `adhoc_${item.id}`;
                if (hideChecked && shoppingHave[key]) return;
                
                const aisle = getIngredientAisle(item.text, currentShopId);
                const aisleOrder = shopAisles.findIndex(a => a.name === aisle);
                
                items.push({
                    text: item.text,
                    context: 'Extra item',
                    aisle: aisle,
                    aisleOrder: aisleOrder === -1 ? 9999 : aisleOrder,
                    have: !!shoppingHave[key]
                });
            });
            
            // Sort items
            if (sortMethod === 'aisle' && shopAisles.length > 0) {
                items.sort((a, b) => {
                    if (a.aisleOrder !== b.aisleOrder) return a.aisleOrder - b.aisleOrder;
                    return a.text.localeCompare(b.text);
                });
            } else {
                items.sort((a, b) => a.text.localeCompare(b.text));
            }
            
            // Generate print HTML
            let html = '';
            
            if (sortMethod === 'aisle' && shopAisles.length > 0) {
                // Group by aisle
                const aisleGroups = {};
                items.forEach(item => {
                    const aisleName = item.aisle || '__uncategorised__';
                    if (!aisleGroups[aisleName]) aisleGroups[aisleName] = [];
                    aisleGroups[aisleName].push(item);
                });
                
                // Render each aisle
                shopAisles.forEach((aisle, index) => {
                    const aisleItems = aisleGroups[aisle.name];
                    if (aisleItems && aisleItems.length > 0) {
                        html += `<div class="print-aisle-section">`;
                        html += `<div class="print-aisle-title">${index + 1}. ${aisle.name}</div>`;
                        aisleItems.forEach(item => {
                            html += `<div class="print-item">
                                <div class="print-checkbox"></div>
                                <div class="print-item-text">${item.text}<div class="print-item-context">${item.context}</div></div>
                            </div>`;
                        });
                        html += `</div>`;
                    }
                });

                // Uncategorised at end
                const uncategorised = aisleGroups['__uncategorised__'];
                if (uncategorised && uncategorised.length > 0) {
                    html += `<div class="print-aisle-section">`;
                    html += `<div class="print-aisle-title">Other</div>`;
                    uncategorised.forEach(item => {
                        html += `<div class="print-item">
                            <div class="print-checkbox"></div>
                            <div class="print-item-text">${item.text}<div class="print-item-context">${item.context}</div></div>
                        </div>`;
                    });
                    html += `</div>`;
                }
            } else {
                // Simple alphabetical list
                items.forEach(item => {
                    html += `<div class="print-item">
                        <div class="print-checkbox"></div>
                        <div class="print-item-text">${item.text}<div class="print-item-context">${item.context}</div></div>
                    </div>`;
                });
            }
            
            printContent.innerHTML = html;
            
            // Update print date
            printDateEl.textContent = `${formatDisplayDate(shoppingDateFrom)} ‚Äì ${formatDisplayDate(shoppingDateTo)} ‚Ä¢ ${items.length} items`;
            
            closePrintModal();

            // Tag body so only shopping content shows
            document.body.classList.add('printing-shopping');
            document.body.classList.remove('printing-planner');

            setTimeout(() => {
                window.print();
                setTimeout(() => document.body.classList.remove('printing-shopping'), 500);
            }, 100);
        }
        window.printShoppingList = printShoppingList;

        function openPrintModal() {
            document.getElementById('print-modal').classList.add('active');
        }
        window.openPrintModal = openPrintModal;

        function closePrintModal() {
            document.getElementById('print-modal').classList.remove('active');
        }
        window.closePrintModal = closePrintModal;

        function openPlannerPrintModal() {
            document.getElementById('planner-print-modal').classList.add('active');
        }
        window.openPlannerPrintModal = openPlannerPrintModal;

        function closePlannerPrintModal() {
            document.getElementById('planner-print-modal').classList.remove('active');
        }
        window.closePlannerPrintModal = closePlannerPrintModal;

        function printMealPlan() {
            const view = document.querySelector('input[name="planner-print-view"]:checked')?.value || 'week';
            const printBody = document.getElementById('print-planner-body');
            const printDateEl = document.getElementById('print-planner-date');

            if (view === 'week') {
                printDateEl.textContent = formatWeekDisplay(currentWeekStart) + ' ‚Ä¢ Printed ' + new Date().toLocaleDateString('en-GB');
                printBody.innerHTML = generateWeekPrintHtml();
            } else {
                const monthName = currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                printDateEl.textContent = monthName + ' ‚Ä¢ Printed ' + new Date().toLocaleDateString('en-GB');
                printBody.innerHTML = generateMonthPrintHtml();
            }

            closePlannerPrintModal();

            document.body.classList.add('printing-planner');
            document.body.classList.remove('printing-shopping');

            setTimeout(() => {
                window.print();
                setTimeout(() => document.body.classList.remove('printing-planner'), 500);
            }, 100);
        }
        window.printMealPlan = printMealPlan;

        function generateWeekPrintHtml() {
            let html = '<div class="print-week-grid">';

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dateStr = formatDate(date);
                const dayMeals = mealPlan[dateStr] || {};
                const note = dayNotes[dateStr] || '';

                html += `<div class="print-day-card">`;
                html += `<div class="print-day-header">${getDayName(date)}<div class="print-day-date">${formatUKLongDate(date)}</div></div>`;

                getMealTypes().forEach(meal => {
                    const mealKey = meal.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    const recipeId = dayMeals[mealKey] || dayMeals[meal] || dayMeals[meal.toLowerCase()];
                    const recipe = recipeId ? recipes.find(r => r.id === recipeId) : null;

                    html += `<div class="print-meal-slot">`;
                    html += `<div class="print-meal-label">${escapeHtml(meal)}</div>`;
                    html += `<div class="print-meal-name">${recipe ? escapeHtml(recipe.name) : '‚Äî'}</div>`;
                    html += `</div>`;
                });

                if (note) {
                    html += `<div class="print-day-note">üìù ${escapeHtml(note)}</div>`;
                }

                html += `</div>`;
            }

            html += '</div>';
            return html;
        }

        function generateMonthPrintHtml() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);

            const startDate = new Date(firstDay);
            const dow = firstDay.getDay();
            startDate.setDate(startDate.getDate() - (dow === 0 ? 6 : dow - 1));

            let html = '<div class="print-month-grid">';

            // Header row
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
                html += `<div class="print-month-header-cell">${day}</div>`;
            });

            // Day cells (6 weeks)
            const cur = new Date(startDate);
            for (let i = 0; i < 42; i++) {
                const dateStr = formatDate(cur);
                const dayMeals = mealPlan[dateStr] || {};
                const isOtherMonth = cur.getMonth() !== month;

                html += `<div class="print-month-day${isOtherMonth ? ' other-month' : ''}">`;
                html += `<div class="print-month-day-number">${cur.getDate()}</div>`;

                getMealTypes().forEach(meal => {
                    const mealKey = meal.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    const recipeId = dayMeals[mealKey] || dayMeals[meal] || dayMeals[meal.toLowerCase()];
                    const recipe = recipeId ? recipes.find(r => r.id === recipeId) : null;
                    if (recipe) {
                        html += `<div class="print-month-meal"><span class="print-month-meal-label">${escapeHtml(meal[0])}</span> ${escapeHtml(recipe.name)}</div>`;
                    }
                });

                html += `</div>`;
                cur.setDate(cur.getDate() + 1);
            }

            html += '</div>';
            return html;
        }

        // =====================
        // Export Functions
        // =====================

        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('show');
            
            // Close menu when clicking outside
            if (menu.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', closeExportMenuOnClickOutside);
                }, 10);
            }
        }
        window.toggleExportMenu = toggleExportMenu;

        function closeExportMenuOnClickOutside(e) {
            const menu = document.getElementById('export-menu');
            const dropdown = e.target.closest('.export-dropdown');
            if (!dropdown) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeExportMenuOnClickOutside);
            }
        }

        function getShoppingListData() {
            // Get all current shopping list items (respecting date range)
            const ingredients = [];
            
            // Add recipe ingredients from all meal plan dates
            Object.keys(mealPlan).forEach(dateStr => {
                const date = new Date(dateStr);
                
                // Apply date range filter
                if (!shouldIncludeDateInRange(date)) return;
                
                const dayName = getDayName(date);
                const dayMeals = mealPlan[dateStr] || {};
                
                // Iterate over actual meals in the plan
                for (const mealKey in dayMeals) {
                    const recipeId = dayMeals[mealKey];
                    if (!recipeId) continue;
                    
                    const recipe = recipes.find(r => r.id === recipeId);
                    if (!recipe || recipe.titleOnly || !recipe.ingredients) continue;
                    
                    recipe.ingredients.forEach(ing => {
                        // Handle both old string format and new object format
                        let ingredientName;
                        if (typeof ing === 'string') {
                            ingredientName = ing;
                        } else if (ing && ing.name) {
                            ingredientName = ing.name;
                        } else {
                            return;
                        }
                        
                        const uniqueKey = `${dateStr}_${mealKey}_${recipe.id}_${ingredientName.toLowerCase()}`;
                        ingredients.push({
                            text: ingredientName,
                            recipeName: recipe.name,
                            dayName: dayName,
                            dateDisplay: formatUKLongDate(date),
                            dateStr: dateStr,
                            have: !!shoppingHave[uniqueKey],
                            isAdhoc: false
                        });
                    });
                }
            });

            // Add ad-hoc items
            adhocItems.forEach(item => {
                ingredients.push({
                    text: item.text,
                    recipeName: 'Extra item',
                    dayName: '',
                    dateDisplay: '',
                    dateStr: '',
                    have: !!shoppingHave[`adhoc_${item.id}`],
                    isAdhoc: true
                });
            });
            
            return ingredients;
        }

        function exportAsText() {
            const items = getShoppingListData();
            const today = getToday();
            // Export only items still needed to buy, excluding past meal dates
            const needItems = items.filter(i => !i.have && (!i.dateStr || new Date(i.dateStr) >= today));

            let text = 'üçΩ SHOPPING LIST\n';
            text += `${formatDisplayDate(shoppingDateFrom)} ‚Äì ${formatDisplayDate(shoppingDateTo)}\n`;
            text += '‚îÄ'.repeat(30) + '\n\n';

            if (needItems.length > 0) {
                text += 'üõí NEED TO BUY:\n';
                needItems.forEach(item => {
                    const context = item.dateDisplay ? `${item.dateDisplay} ¬∑ ${item.recipeName}` : item.recipeName;
                    text += `‚òê ${item.text} (${context})\n`;
                });
            } else {
                text += 'Nothing left to buy!\n';
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                showSyncStatus('success', 'Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showSyncStatus('error', 'Failed to copy');
            });
            
            document.getElementById('export-menu').classList.remove('show');
        }
        window.exportAsText = exportAsText;

        function exportAsCSV() {
            const items = getShoppingListData();
            const today = getToday();
            // Export only items still needed to buy, excluding past meal dates
            const needItems = items.filter(i => !i.have && (!i.dateStr || new Date(i.dateStr) >= today));

            // CSV header
            let csv = 'Item,Date,Recipe\n';

            needItems.forEach(item => {
                const date = item.dateDisplay || '';
                const recipe = item.recipeName || '';
                // Escape quotes in CSV
                const escapedItem = item.text.replace(/"/g, '""');
                const escapedDate = date.replace(/"/g, '""');
                const escapedRecipe = recipe.replace(/"/g, '""');
                csv += `"${escapedItem}","${escapedDate}","${escapedRecipe}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `shopping-list-${formatDate(currentWeekStart)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.getElementById('export-menu').classList.remove('show');
            showSyncStatus('success', 'CSV downloaded!');
        }
        window.exportAsCSV = exportAsCSV;

        // =====================
        // Ad-hoc Items
        // =====================

        function handleAddItemKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addAdHocItem();
            }
        }
        window.handleAddItemKeypress = handleAddItemKeypress;

        async function addAdHocItem() {
            const input = document.getElementById('add-item-input');
            const text = input.value.trim();
            
            if (!text || !currentUser) return;
            
            const id = generateId();
            
            showSyncStatus('syncing', 'Adding...');
            try {
                await setDoc(doc(db, "users", currentUser.uid, "adhocItems", id), {
                    text: text,
                    createdAt: new Date().toISOString()
                });
                input.value = '';
                showSyncStatus('success', 'Added!');
            } catch (error) {
                console.error("Error adding ad-hoc item:", error);
                showSyncStatus('error', 'Failed to add');
            }
        }
        window.addAdHocItem = addAdHocItem;

        async function removeAdhocItem(itemId) {
            if (!currentUser) return;

            showSyncStatus('syncing', 'Removing...');
            try {
                await deleteDoc(doc(db, "users", currentUser.uid, "adhocItems", itemId));
                // Also remove from shoppingHave
                delete shoppingHave[`adhoc_${itemId}`];
                await saveShoppingHaveToFirebase();
                showSyncStatus('success', 'Removed');
            } catch (error) {
                console.error("Error removing ad-hoc item:", error);
                showSyncStatus('error', 'Failed to remove');
            }
        }
        window.removeAdhocItem = removeAdhocItem;

        function getAllAdHocSuggestions() {
            const items = new Set();
            // Add all ingredient names from recipes
            recipes.forEach(recipe => {
                if (recipe.ingredients) {
                    recipe.ingredients.forEach(ing => {
                        const name = typeof ing === 'string' ? ing : (ing && ing.name ? ing.name : null);
                        if (name) items.add(name.trim());
                    });
                }
            });
            // Add all previous adhoc item texts
            adhocItems.forEach(item => {
                if (item.text) items.add(item.text.trim());
            });
            return Array.from(items).sort((a, b) => a.localeCompare(b));
        }

        function showAdHocAutocomplete(input) {
            const value = input.value.toLowerCase().trim();
            const wrapper = input.parentElement;

            // Remove existing dropdown
            const existing = wrapper.querySelector('.autocomplete-dropdown');
            if (existing) existing.remove();

            if (value.length < 1) return;

            const allSuggestions = getAllAdHocSuggestions();
            const matches = allSuggestions.filter(name =>
                name.toLowerCase().includes(value) && name.toLowerCase() !== value
            ).slice(0, 8);

            if (matches.length === 0) return;

            const dropdown = document.createElement('div');
            dropdown.className = 'autocomplete-dropdown';

            matches.forEach(name => {
                const aisle = getIngredientAisle(name, currentShopId);
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `${escapeHtml(name)}${aisle ? `<span class="autocomplete-aisle">(${escapeHtml(aisle)})</span>` : ''}`;
                item.onmousedown = (e) => {
                    e.preventDefault();
                    input.value = name;
                    wrapper.querySelector('.autocomplete-dropdown')?.remove();
                };
                dropdown.appendChild(item);
            });

            wrapper.appendChild(dropdown);
        }
        window.showAdHocAutocomplete = showAdHocAutocomplete;

        function hideAdHocAutocomplete(input) {
            setTimeout(() => {
                const wrapper = input.parentElement;
                const dropdown = wrapper.querySelector('.autocomplete-dropdown');
                if (dropdown) dropdown.remove();
            }, 150);
        }
        window.hideAdHocAutocomplete = hideAdHocAutocomplete;

        async function clearCheckedAdhocItems() {
            if (!currentUser) return;

            const checkedIds = adhocItems
                .filter(item => shoppingHave[`adhoc_${item.id}`])
                .map(item => item.id);

            if (checkedIds.length === 0) {
                showSyncStatus('success', 'No checked extra items to remove');
                return;
            }

            if (!confirm(`Remove ${checkedIds.length} checked extra item(s)? They will be permanently deleted.`)) return;

            showSyncStatus('syncing', 'Removing...');
            try {
                for (const id of checkedIds) {
                    await deleteDoc(doc(db, "users", currentUser.uid, "adhocItems", id));
                    delete shoppingHave[`adhoc_${id}`];
                }
                await saveShoppingHaveToFirebase();
                showSyncStatus('success', 'Removed');
            } catch (error) {
                console.error("Error removing checked ad-hoc items:", error);
                showSyncStatus('error', 'Failed to remove');
            }
        }
        window.clearCheckedAdhocItems = clearCheckedAdhocItems;

        // =====================
        // Date Filtering Helper
        // =====================

        function shouldIncludeDateInRange(date) {
            // If no range set, include from today onwards
            if (!shoppingDateFrom && !shoppingDateTo) {
                return date >= getToday();
            }
            
            const dateTime = date.getTime();
            
            if (shoppingDateFrom && shoppingDateTo) {
                return dateTime >= shoppingDateFrom.getTime() && dateTime <= shoppingDateTo.getTime();
            } else if (shoppingDateFrom) {
                return dateTime >= shoppingDateFrom.getTime();
            } else if (shoppingDateTo) {
                return dateTime <= shoppingDateTo.getTime();
            }
            
            return true;
        }

        function initDateRangePicker() {
            const today = getToday();
            const weekEnd = new Date(today);
            weekEnd.setDate(weekEnd.getDate() + 6);

            shoppingDateFrom = today;
            shoppingDateTo = weekEnd;

            document.getElementById('date-from').value = formatDate(today);
            document.getElementById('date-to').value = formatDate(weekEnd);

            // Ensure the 7-day preset button is shown as active on init
            document.querySelectorAll('.date-preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.preset === '7days');
            });
        }

        function onDateRangeChange() {
            const fromInput = document.getElementById('date-from');
            const toInput = document.getElementById('date-to');
            
            shoppingDateFrom = fromInput.value ? new Date(fromInput.value) : null;
            shoppingDateTo = toInput.value ? new Date(toInput.value) : null;
            
            // Clear active preset buttons
            document.querySelectorAll('.date-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            renderShoppingList();
        }
        window.onDateRangeChange = onDateRangeChange;

        function setDatePreset(preset) {
            const today = getToday();
            let from = new Date(today);
            let to = new Date(today);
            
            switch (preset) {
                case 'today':
                    // from and to are already today
                    break;
                case '3days':
                    to.setDate(to.getDate() + 2);
                    break;
                case '7days':
                    // Rolling 7 days from today
                    to.setDate(to.getDate() + 6);
                    break;
                case 'week': {
                    // Current calendar week: Monday to Sunday
                    const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon...
                    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    from = new Date(today);
                    from.setDate(from.getDate() - daysToMonday);
                    to = new Date(from);
                    to.setDate(to.getDate() + 6);
                    break;
                }
                case 'all':
                    // Get earliest date from current week start
                    from = new Date(currentWeekStart);
                    // Get date 30 days in future
                    to = new Date(today);
                    to.setDate(to.getDate() + 30);
                    break;
            }
            
            shoppingDateFrom = from;
            shoppingDateTo = to;
            
            document.getElementById('date-from').value = formatDate(from);
            document.getElementById('date-to').value = formatDate(to);
            
            // Update active preset button
            document.querySelectorAll('.date-preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.preset === preset);
            });
            
            renderShoppingList();
        }
        window.setDatePreset = setDatePreset;

        // =====================
        // Shops & Aisles Management
        // =====================

        function renderShopsSettings() {
            const container = document.getElementById('shops-list');
            const empty = document.getElementById('shops-empty');
            
            if (!container) return;
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            container.innerHTML = shops.map(shop => {
                const isCollapsed = !!collapsedShops[shop.id];
                return `
                <div class="shop-card ${shop.isDefault ? 'default' : ''}">
                    <div class="shop-card-header">
                        <div class="shop-name">
                            ${escapeHtml(shop.name)}
                            ${shop.isDefault ? '<span class="shop-default-badge">Default</span>' : ''}
                        </div>
                        <div class="shop-actions">
                            <button class="shop-collapse-btn" onclick="toggleAisleCollapse('${shop.id}')" title="${isCollapsed ? 'Show aisles' : 'Hide aisles'}">${isCollapsed ? '‚ñ∂ Aisles' : '‚ñº Aisles'}</button>
                            <button class="share-shop-btn" onclick="shareShop('${shop.id}')">Share Shop</button>
                            ${!shop.isDefault ? `<button class="shop-action-btn" onclick="setDefaultShop('${shop.id}')" title="Set as default">‚≠ê</button>` : ''}
                            <button class="shop-action-btn" onclick="editShop('${shop.id}')" title="Edit name">‚úèÔ∏è</button>
                            <button class="shop-action-btn danger" onclick="deleteShop('${shop.id}')" title="Delete shop">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="aisle-list" ${isCollapsed ? 'style="display: none;"' : ''}>
                        ${(shop.aisles || []).map((aisle, index) => `
                            <div class="aisle-item">
                                <span class="aisle-order">${index + 1}</span>
                                <span class="aisle-name">${escapeHtml(aisle.name)}</span>
                                <div class="aisle-move-btns">
                                    <button class="aisle-move-btn" onclick="moveAisle('${shop.id}', ${index}, -1)" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                                    <button class="aisle-move-btn" onclick="moveAisle('${shop.id}', ${index}, 1)" ${index === shop.aisles.length - 1 ? 'disabled' : ''}>‚ñº</button>
                                </div>
                                <button class="aisle-delete-btn" onclick="deleteAisle('${shop.id}', ${index})" title="Delete aisle">‚úï</button>
                            </div>
                        `).join('') || '<p class="text-muted" style="padding: 0.5rem;">No aisles yet. Add your first aisle below.</p>'}
                        <div class="add-aisle-row">
                            <input type="text" class="add-aisle-input" id="add-aisle-${shop.id}" placeholder="New aisle name..." onkeypress="handleAddAisleKeypress(event, '${shop.id}')">
                            <button class="btn btn-primary btn-small" onclick="addAisle('${shop.id}')">Add</button>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // Also update the ingredient dictionary if visible
            renderIngredientDictionary();
        }
        window.renderShopsSettings = renderShopsSettings;

        function toggleAisleCollapse(shopId) {
            collapsedShops[shopId] = !collapsedShops[shopId];
            renderShopsSettings();
        }
        window.toggleAisleCollapse = toggleAisleCollapse;

        function updateShopSelector() {
            const selector = document.getElementById('shop-selector');
            const container = document.getElementById('shop-selector-container');
            
            if (!selector || !container) return;
            
            if (shops.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            
            selector.innerHTML = shops.map(shop => `
                <option value="${shop.id}" ${shop.id === currentShopId ? 'selected' : ''}>
                    ${escapeHtml(shop.name)}
                </option>
            `).join('');
        }
        window.updateShopSelector = updateShopSelector;

        function onShopChange() {
            const selector = document.getElementById('shop-selector');
            currentShopId = selector.value;
            renderShoppingList();
        }
        window.onShopChange = onShopChange;

        function openAddShopModal() {
            document.getElementById('shop-modal-title').textContent = 'Add Shop';
            document.getElementById('shop-form').reset();
            document.getElementById('shop-id').value = '';
            document.getElementById('shop-default').checked = shops.length === 0; // Default if first shop
            editingShopId = null;
            document.getElementById('shop-modal').classList.add('active');
        }
        window.openAddShopModal = openAddShopModal;

        function closeShopModal() {
            document.getElementById('shop-modal').classList.remove('active');
            editingShopId = null;
        }
        window.closeShopModal = closeShopModal;

        function editShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            document.getElementById('shop-modal-title').textContent = 'Edit Shop';
            document.getElementById('shop-id').value = shop.id;
            document.getElementById('shop-name').value = shop.name;
            document.getElementById('shop-default').checked = shop.isDefault;
            editingShopId = shopId;
            document.getElementById('shop-modal').classList.add('active');
        }
        window.editShop = editShop;

        async function saveShop(event) {
            event.preventDefault();
            if (!currentUser) return;
            
            const id = document.getElementById('shop-id').value || generateId();
            const name = document.getElementById('shop-name').value.trim();
            const isDefault = document.getElementById('shop-default').checked;
            
            // Get existing shop data to preserve aisles
            const existingShop = shops.find(s => s.id === id);
            const aisles = existingShop?.aisles || [];
            
            showSyncStatus('syncing', 'Saving...');
            
            try {
                // If setting as default, unset other defaults
                if (isDefault) {
                    for (const shop of shops) {
                        if (shop.id !== id && shop.isDefault) {
                            await setDoc(doc(db, "users", currentUser.uid, "shops", shop.id), {
                                ...shop,
                                isDefault: false
                            });
                        }
                    }
                }
                
                await setDoc(doc(db, "users", currentUser.uid, "shops", id), {
                    name,
                    isDefault,
                    aisles
                });
                
                showSyncStatus('success', 'Saved!');
                closeShopModal();
            } catch (error) {
                console.error("Error saving shop:", error);
                showSyncStatus('error', 'Save failed');
            }
        }
        window.saveShop = saveShop;

        async function setDefaultShop(shopId) {
            if (!currentUser) return;
            
            showSyncStatus('syncing', 'Updating...');
            
            try {
                // Unset current defaults and set new default
                for (const shop of shops) {
                    if (shop.isDefault || shop.id === shopId) {
                        await setDoc(doc(db, "users", currentUser.uid, "shops", shop.id), {
                            ...shop,
                            isDefault: shop.id === shopId
                        });
                    }
                }
                
                currentShopId = shopId;
                showSyncStatus('success', 'Updated!');
            } catch (error) {
                console.error("Error setting default shop:", error);
                showSyncStatus('error', 'Update failed');
            }
        }
        window.setDefaultShop = setDefaultShop;

        async function deleteShop(shopId) {
            if (!confirm('Delete this shop and all its aisles? This cannot be undone.')) return;
            if (!currentUser) return;
            
            showSyncStatus('syncing', 'Deleting...');
            
            try {
                await deleteDoc(doc(db, "users", currentUser.uid, "shops", shopId));
                
                // If we deleted the current shop, switch to another
                if (currentShopId === shopId) {
                    const remaining = shops.filter(s => s.id !== shopId);
                    currentShopId = remaining[0]?.id || null;
                }
                
                showSyncStatus('success', 'Deleted!');
            } catch (error) {
                console.error("Error deleting shop:", error);
                showSyncStatus('error', 'Delete failed');
            }
        }
        window.deleteShop = deleteShop;

        function handleAddAisleKeypress(event, shopId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addAisle(shopId);
            }
        }
        window.handleAddAisleKeypress = handleAddAisleKeypress;

        async function addAisle(shopId) {
            const input = document.getElementById(`add-aisle-${shopId}`);
            const name = input.value.trim();
            
            if (!name || !currentUser) return;
            
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            const aisles = shop.aisles || [];
            aisles.push({ name, order: aisles.length + 1 });
            
            showSyncStatus('syncing', 'Adding...');
            
            try {
                await setDoc(doc(db, "users", currentUser.uid, "shops", shopId), {
                    ...shop,
                    aisles
                });
                
                input.value = '';
                showSyncStatus('success', 'Added!');
            } catch (error) {
                console.error("Error adding aisle:", error);
                showSyncStatus('error', 'Add failed');
            }
        }
        window.addAisle = addAisle;

        async function moveAisle(shopId, index, direction) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop || !currentUser) return;
            
            const aisles = [...(shop.aisles || [])];
            const newIndex = index + direction;
            
            if (newIndex < 0 || newIndex >= aisles.length) return;
            
            // Swap
            [aisles[index], aisles[newIndex]] = [aisles[newIndex], aisles[index]];
            
            showSyncStatus('syncing', 'Moving...');
            
            try {
                await setDoc(doc(db, "users", currentUser.uid, "shops", shopId), {
                    ...shop,
                    aisles
                });
                showSyncStatus('success', 'Moved!');
            } catch (error) {
                console.error("Error moving aisle:", error);
                showSyncStatus('error', 'Move failed');
            }
        }
        window.moveAisle = moveAisle;

        async function deleteAisle(shopId, index) {
            if (!confirm('Delete this aisle?')) return;
            
            const shop = shops.find(s => s.id === shopId);
            if (!shop || !currentUser) return;
            
            const aisles = [...(shop.aisles || [])];
            aisles.splice(index, 1);
            
            showSyncStatus('syncing', 'Deleting...');
            
            try {
                await setDoc(doc(db, "users", currentUser.uid, "shops", shopId), {
                    ...shop,
                    aisles
                });
                showSyncStatus('success', 'Deleted!');
            } catch (error) {
                console.error("Error deleting aisle:", error);
                showSyncStatus('error', 'Delete failed');
            }
        }
        window.deleteAisle = deleteAisle;

        // =====================
        // Ingredient Aisle Assignment
        // =====================

        function getIngredientAisle(ingredientText, shopId) {
            if (!ingredientText || !shopId) return null;
            
            const normalized = ingredientText.toLowerCase().trim();
            const aisleData = ingredientAisles[normalized];
            
            if (aisleData && aisleData[shopId]) {
                return aisleData[shopId];
            }
            
            return null;
        }

        async function setIngredientAisle(ingredientText, shopId, aisleName) {
            if (!currentUser || !ingredientText || !shopId) return;
            
            const normalized = ingredientText.toLowerCase().trim();
            
            // Update local copy
            if (!ingredientAisles[normalized]) {
                ingredientAisles[normalized] = {};
            }
            ingredientAisles[normalized][shopId] = aisleName;
            
            showSyncStatus('syncing', 'Saving...');
            
            try {
                await setDoc(doc(db, "users", currentUser.uid, "settings", "ingredientAisles"), ingredientAisles);
                showSyncStatus('success', 'Saved!');
            } catch (error) {
                console.error("Error saving ingredient aisle:", error);
                showSyncStatus('error', 'Save failed');
            }
        }
        window.setIngredientAisle = setIngredientAisle;

        function showAisleSelector(ingredientText, buttonEl) {
            // Close any existing dropdown
            closeAisleSelector();
            
            const shop = shops.find(s => s.id === currentShopId);
            if (!shop || !shop.aisles || shop.aisles.length === 0) {
                alert('Please add aisles to your shop first (Settings ‚Üí Shops & Aisles)');
                return;
            }
            
            const dropdown = document.createElement('div');
            dropdown.className = 'aisle-select-dropdown';
            dropdown.id = 'aisle-selector-dropdown';
            
            dropdown.innerHTML = shop.aisles.map(aisle => `
                <div class="aisle-select-option" onclick="selectAisleForIngredient('${escapeHtml(ingredientText).replace(/'/g, "\\'")}', '${escapeHtml(aisle.name).replace(/'/g, "\\'")}')">
                    ${escapeHtml(aisle.name)}
                </div>
            `).join('');
            
            // Position dropdown
            const rect = buttonEl.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = (rect.bottom + 4) + 'px';
            dropdown.style.left = rect.left + 'px';
            
            document.body.appendChild(dropdown);
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', closeAisleSelectorOnClickOutside);
            }, 10);
        }
        window.showAisleSelector = showAisleSelector;

        function closeAisleSelector() {
            const dropdown = document.getElementById('aisle-selector-dropdown');
            if (dropdown) {
                dropdown.remove();
            }
            document.removeEventListener('click', closeAisleSelectorOnClickOutside);
        }

        function closeAisleSelectorOnClickOutside(e) {
            if (!e.target.closest('.aisle-select-dropdown') && !e.target.closest('.set-aisle-btn')) {
                closeAisleSelector();
            }
        }

        async function selectAisleForIngredient(ingredientText, aisleName) {
            closeAisleSelector();
            await setIngredientAisle(ingredientText, currentShopId, aisleName);
            renderShoppingList();
        }
        window.selectAisleForIngredient = selectAisleForIngredient;

        // =====================
        // Ingredient Dictionary Manager
        // =====================

        let dictionaryShopId = null;
        let selectedIngredients = new Set();

        function getAllKnownIngredients() {
            // Collect all unique ingredients from recipes and meal plan
            const ingredients = new Set();
            
            // From recipes
            recipes.forEach(recipe => {
                if (recipe.ingredients) {
                    recipe.ingredients.forEach(ing => {
                        // Handle both old string format and new object format
                        let name;
                        if (typeof ing === 'string') {
                            name = ing;
                        } else if (ing && ing.name) {
                            name = ing.name;
                        } else {
                            return;
                        }
                        ingredients.add(name.toLowerCase().trim());
                    });
                }
            });
            
            // From ad-hoc items
            adhocItems.forEach(item => {
                ingredients.add(item.text.toLowerCase().trim());
            });
            
            return Array.from(ingredients).sort();
        }

        function renderIngredientDictionary() {
            const noShops = document.getElementById('dictionary-no-shops');
            const container = document.getElementById('dictionary-container');
            const tabsContainer = document.getElementById('dictionary-shop-tabs');
            const statsContainer = document.getElementById('dictionary-stats');
            const tableBody = document.getElementById('dictionary-table-body');
            const emptyState = document.getElementById('dictionary-empty');
            const bulkActions = document.getElementById('dictionary-bulk-actions');
            const bulkAisleSelect = document.getElementById('dictionary-bulk-aisle');
            const searchInput = document.getElementById('dictionary-search');
            const filterSelect = document.getElementById('dictionary-filter');
            
            if (!container) return;
            
            // Check if we have shops
            if (shops.length === 0) {
                noShops.style.display = 'block';
                container.style.display = 'none';
                return;
            }
            
            noShops.style.display = 'none';
            container.style.display = 'block';
            
            // Set default dictionary shop if not set
            if (!dictionaryShopId || !shops.find(s => s.id === dictionaryShopId)) {
                const defaultShop = shops.find(s => s.isDefault);
                dictionaryShopId = defaultShop ? defaultShop.id : shops[0].id;
            }
            
            // Render shop tabs
            tabsContainer.innerHTML = shops.map(shop => `
                <button class="dictionary-shop-tab ${shop.id === dictionaryShopId ? 'active' : ''}" 
                        onclick="switchDictionaryShop('${shop.id}')">
                    ${escapeHtml(shop.name)}
                </button>
            `).join('');
            
            // Get current shop
            const currentShop = shops.find(s => s.id === dictionaryShopId);
            const shopAisles = currentShop?.aisles || [];
            
            // Update bulk aisle select
            bulkAisleSelect.innerHTML = '<option value="">Select aisle...</option>' + 
                shopAisles.map(a => `<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
            
            // Get all ingredients
            let allIngredients = getAllKnownIngredients();
            
            // Apply search filter
            const searchTerm = searchInput?.value?.toLowerCase() || '';
            if (searchTerm) {
                allIngredients = allIngredients.filter(ing => ing.includes(searchTerm));
            }
            
            // Apply categorisation filter
            const filterValue = filterSelect?.value || 'all';
            allIngredients = allIngredients.filter(ing => {
                const aisle = getIngredientAisle(ing, dictionaryShopId);
                if (filterValue === 'categorised') return aisle !== null;
                if (filterValue === 'uncategorised') return aisle === null;
                return true;
            });
            
            // Calculate stats
            const allKnown = getAllKnownIngredients();
            const categorisedCount = allKnown.filter(ing => getIngredientAisle(ing, dictionaryShopId) !== null).length;
            const uncategorisedCount = allKnown.length - categorisedCount;
            
            statsContainer.innerHTML = `
                <div class="dictionary-stat">
                    <span class="dictionary-stat-value">${allKnown.length}</span>
                    <span>total ingredients</span>
                </div>
                <div class="dictionary-stat">
                    <span class="dictionary-stat-value">${categorisedCount}</span>
                    <span>categorised</span>
                </div>
                <div class="dictionary-stat">
                    <span class="dictionary-stat-value">${uncategorisedCount}</span>
                    <span>uncategorised</span>
                </div>
            `;
            
            // Show/hide bulk actions
            bulkActions.style.display = uncategorisedCount > 0 && shopAisles.length > 0 ? 'flex' : 'none';
            
            // Render table
            if (allIngredients.length === 0) {
                tableBody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tableBody.innerHTML = allIngredients.map(ing => {
                const aisle = getIngredientAisle(ing, dictionaryShopId);
                const isSelected = selectedIngredients.has(ing);
                const escapedIng = escapeHtml(ing).replace(/'/g, "\\'");
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleIngredientSelection('${escapedIng}', this.checked)">
                        </td>
                        <td class="dictionary-ingredient">${escapeHtml(ing)}</td>
                        <td>
                            <select class="dictionary-aisle-select" onchange="updateIngredientAisle('${escapedIng}', this.value)">
                                <option value="" ${!aisle ? 'selected' : ''}>Uncategorised</option>
                                ${shopAisles.map(a => `
                                    <option value="${escapeHtml(a.name)}" ${aisle === a.name ? 'selected' : ''}>
                                        ${escapeHtml(a.name)}
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                        <td>
                            ${aisle ? `<button class="dictionary-remove-btn" onclick="removeIngredientAisle('${escapedIng}')" title="Remove aisle assignment">‚úï</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        window.renderIngredientDictionary = renderIngredientDictionary;

        function switchDictionaryShop(shopId) {
            dictionaryShopId = shopId;
            selectedIngredients.clear();
            document.getElementById('dictionary-select-all').checked = false;
            renderIngredientDictionary();
        }
        window.switchDictionaryShop = switchDictionaryShop;

        function toggleIngredientSelection(ingredient, isSelected) {
            if (isSelected) {
                selectedIngredients.add(ingredient);
            } else {
                selectedIngredients.delete(ingredient);
            }
            updateSelectAllCheckbox();
        }
        window.toggleIngredientSelection = toggleIngredientSelection;

        function toggleSelectAllIngredients() {
            const selectAll = document.getElementById('dictionary-select-all');
            const allIngredients = getAllKnownIngredients();
            
            // Apply current filters
            const searchTerm = document.getElementById('dictionary-search')?.value?.toLowerCase() || '';
            const filterValue = document.getElementById('dictionary-filter')?.value || 'all';
            
            const filteredIngredients = allIngredients.filter(ing => {
                if (searchTerm && !ing.includes(searchTerm)) return false;
                const aisle = getIngredientAisle(ing, dictionaryShopId);
                if (filterValue === 'categorised') return aisle !== null;
                if (filterValue === 'uncategorised') return aisle === null;
                return true;
            });
            
            if (selectAll.checked) {
                filteredIngredients.forEach(ing => selectedIngredients.add(ing));
            } else {
                filteredIngredients.forEach(ing => selectedIngredients.delete(ing));
            }
            
            renderIngredientDictionary();
        }
        window.toggleSelectAllIngredients = toggleSelectAllIngredients;

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('dictionary-select-all');
            const allIngredients = getAllKnownIngredients();
            const searchTerm = document.getElementById('dictionary-search')?.value?.toLowerCase() || '';
            const filterValue = document.getElementById('dictionary-filter')?.value || 'all';
            
            const filteredIngredients = allIngredients.filter(ing => {
                if (searchTerm && !ing.includes(searchTerm)) return false;
                const aisle = getIngredientAisle(ing, dictionaryShopId);
                if (filterValue === 'categorised') return aisle !== null;
                if (filterValue === 'uncategorised') return aisle === null;
                return true;
            });
            
            const allSelected = filteredIngredients.length > 0 && 
                                filteredIngredients.every(ing => selectedIngredients.has(ing));
            selectAll.checked = allSelected;
        }

        function selectAllUncategorised() {
            const allIngredients = getAllKnownIngredients();
            allIngredients.forEach(ing => {
                const aisle = getIngredientAisle(ing, dictionaryShopId);
                if (!aisle) {
                    selectedIngredients.add(ing);
                }
            });
            renderIngredientDictionary();
        }
        window.selectAllUncategorised = selectAllUncategorised;

        async function updateIngredientAisle(ingredient, aisleName) {
            if (!dictionaryShopId) return;
            
            if (aisleName) {
                await setIngredientAisle(ingredient, dictionaryShopId, aisleName);
            } else {
                await removeIngredientAisleForShop(ingredient, dictionaryShopId);
            }
            
            renderIngredientDictionary();
            renderShoppingList();
        }
        window.updateIngredientAisle = updateIngredientAisle;

        async function removeIngredientAisle(ingredient) {
            await removeIngredientAisleForShop(ingredient, dictionaryShopId);
            renderIngredientDictionary();
            renderShoppingList();
        }
        window.removeIngredientAisle = removeIngredientAisle;

        async function removeIngredientAisleForShop(ingredient, shopId) {
            if (!currentUser) return;
            
            const normalized = ingredient.toLowerCase().trim();
            
            if (ingredientAisles[normalized]) {
                delete ingredientAisles[normalized][shopId];
                
                // Clean up empty entries
                if (Object.keys(ingredientAisles[normalized]).length === 0) {
                    delete ingredientAisles[normalized];
                }
                
                showSyncStatus('syncing', 'Saving...');
                
                try {
                    await setDoc(doc(db, "users", currentUser.uid, "settings", "ingredientAisles"), ingredientAisles);
                    showSyncStatus('success', 'Saved!');
                } catch (error) {
                    console.error("Error removing ingredient aisle:", error);
                    showSyncStatus('error', 'Save failed');
                }
            }
        }

        async function bulkAssignAisle() {
            const aisleName = document.getElementById('dictionary-bulk-aisle').value;
            
            if (!aisleName) {
                alert('Please select an aisle first.');
                return;
            }
            
            if (selectedIngredients.size === 0) {
                alert('Please select some ingredients first.');
                return;
            }
            
            showSyncStatus('syncing', 'Saving...');
            
            try {
                // Update all selected ingredients
                for (const ingredient of selectedIngredients) {
                    const normalized = ingredient.toLowerCase().trim();
                    if (!ingredientAisles[normalized]) {
                        ingredientAisles[normalized] = {};
                    }
                    ingredientAisles[normalized][dictionaryShopId] = aisleName;
                }
                
                await setDoc(doc(db, "users", currentUser.uid, "settings", "ingredientAisles"), ingredientAisles);
                
                showSyncStatus('success', `Updated ${selectedIngredients.size} ingredients!`);
                selectedIngredients.clear();
                document.getElementById('dictionary-select-all').checked = false;
                document.getElementById('dictionary-bulk-aisle').value = '';
                renderIngredientDictionary();
                renderShoppingList();
            } catch (error) {
                console.error("Error bulk assigning aisles:", error);
                showSyncStatus('error', 'Save failed');
            }
        }
        window.bulkAssignAisle = bulkAssignAisle;

        // Helper to show settings view
        function showView(viewName) {
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.view === viewName);
            });
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            
            // Render settings components when switching to settings
            if (viewName === 'settings') {
                renderIngredientDictionary();
                renderIngredientManager();
                renderMealCategories();
            }
            
            // Setup adhoc autocomplete when switching to shopping
            if (viewName === 'shopping') {
                setTimeout(setupAdhocAutocomplete, 100);
            }
        }
        window.showView = showView;

        // =====================
        // Sharing Functions
        // =====================

        let pendingImportData = null;

        function generateShareId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
        }

        // Share a recipe
        async function shareRecipe() {
            if (!currentViewingRecipeId || !currentUser) return;
            
            const recipe = recipes.find(r => r.id === currentViewingRecipeId);
            if (!recipe) return;
            
            showSyncStatus('syncing', 'Creating share link...');
            
            try {
                const shareId = generateShareId();
                
                // Store in shared collection
                await setDoc(doc(db, "shared", shareId), {
                    type: 'recipe',
                    data: {
                        name: recipe.name,
                        ingredients: recipe.ingredients || [],
                        titleOnly: recipe.titleOnly || false
                    },
                    sharedBy: currentUser.uid,
                    sharedAt: new Date().toISOString()
                });
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?import=${shareId}`;
                
                showShareModal('Share Recipe', shareUrl);
                showSyncStatus('success', 'Link created!');
            } catch (error) {
                console.error("Error sharing recipe:", error);
                showSyncStatus('error', 'Share failed');
            }
        }
        window.shareRecipe = shareRecipe;

        // Share a shop layout with ingredient dictionary
        async function shareShop(shopId) {
            if (!currentUser) return;
            
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            showSyncStatus('syncing', 'Creating share link...');
            
            try {
                const shareId = generateShareId();
                
                // Get ingredient mappings for this shop
                const shopIngredients = {};
                Object.keys(ingredientAisles).forEach(ingredient => {
                    if (ingredientAisles[ingredient][shopId]) {
                        shopIngredients[ingredient] = ingredientAisles[ingredient][shopId];
                    }
                });
                
                // Store in shared collection
                await setDoc(doc(db, "shared", shareId), {
                    type: 'shop',
                    data: {
                        name: shop.name,
                        aisles: shop.aisles || [],
                        ingredientMappings: shopIngredients
                    },
                    sharedBy: currentUser.uid,
                    sharedAt: new Date().toISOString()
                });
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?import=${shareId}`;
                
                showShareModal('Share Shop Layout', shareUrl);
                showSyncStatus('success', 'Link created!');
            } catch (error) {
                console.error("Error sharing shop:", error);
                showSyncStatus('error', 'Share failed');
            }
        }
        window.shareShop = shareShop;

        function showShareModal(title, url) {
            document.getElementById('share-modal-title').textContent = title;
            document.getElementById('share-link-input').value = url;
            document.getElementById('copy-share-btn').textContent = 'Copy';
            document.getElementById('copy-share-btn').classList.remove('copied');
            document.getElementById('share-modal').classList.add('active');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
        }
        window.closeShareModal = closeShareModal;

        function copyShareLink() {
            const input = document.getElementById('share-link-input');
            input.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copy-share-btn');
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.textContent = 'Copy';
                btn.classList.remove('copied');
            }, 2000);
        }
        window.copyShareLink = copyShareLink;

        // Import functions
        async function checkForImport() {
            const urlParams = new URLSearchParams(window.location.search);
            const importId = urlParams.get('import');
            
            if (!importId) return;
            
            // Clear the URL parameter
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Show import modal
            document.getElementById('import-modal').classList.add('active');
            document.getElementById('import-loading').style.display = 'block';
            document.getElementById('import-error').style.display = 'none';
            document.getElementById('import-preview-container').style.display = 'none';
            document.getElementById('import-confirm-btn').style.display = 'none';
            
            try {
                const docSnap = await getDoc(doc(db, "shared", importId));
                
                if (!docSnap.exists()) {
                    document.getElementById('import-loading').style.display = 'none';
                    document.getElementById('import-error').style.display = 'block';
                    return;
                }
                
                const sharedData = docSnap.data();
                pendingImportData = sharedData;
                
                // Show preview
                document.getElementById('import-loading').style.display = 'none';
                document.getElementById('import-preview-container').style.display = 'block';
                document.getElementById('import-confirm-btn').style.display = 'inline-block';
                
                const badge = document.getElementById('import-type-badge');
                const title = document.getElementById('import-preview-title');
                const meta = document.getElementById('import-preview-meta');
                const list = document.getElementById('import-preview-list');
                
                if (sharedData.type === 'recipe') {
                    badge.textContent = 'üç≥ Recipe';
                    badge.className = 'import-type-badge recipe';
                    title.textContent = sharedData.data.name;
                    
                    if (sharedData.data.titleOnly) {
                        meta.textContent = 'Title only (no ingredients)';
                        list.innerHTML = '';
                    } else {
                        meta.textContent = `${sharedData.data.ingredients.length} ingredients`;
                        list.innerHTML = sharedData.data.ingredients.map(ing => {
                            const display = typeof ing === 'string' ? ing : (ing.name || '');
                            return `<div class="import-preview-item">${escapeHtml(display)}</div>`;
                        }).join('');
                    }
                } else if (sharedData.type === 'recipes_bulk') {
                    badge.textContent = 'üç≥ Recipe Collection';
                    badge.className = 'import-type-badge recipe';
                    title.textContent = `${sharedData.data.count} Recipes`;
                    meta.textContent = 'All recipes will be added to your account';
                    
                    list.innerHTML = sharedData.data.recipes.map(r => 
                        `<div class="import-preview-item">${escapeHtml(r.name)}</div>`
                    ).join('');
                } else if (sharedData.type === 'shop') {
                    badge.textContent = 'üè™ Shop Layout';
                    badge.className = 'import-type-badge shop';
                    title.textContent = sharedData.data.name;
                    
                    const aisleCount = sharedData.data.aisles?.length || 0;
                    const mappingCount = Object.keys(sharedData.data.ingredientMappings || {}).length;
                    meta.textContent = `${aisleCount} aisles ‚Ä¢ ${mappingCount} ingredient mappings`;
                    
                    list.innerHTML = (sharedData.data.aisles || []).map((aisle, i) => 
                        `<div class="import-preview-item">${i + 1}. ${escapeHtml(aisle.name)}</div>`
                    ).join('');
                }
                
            } catch (error) {
                console.error("Error loading shared item:", error);
                document.getElementById('import-loading').style.display = 'none';
                document.getElementById('import-error').style.display = 'block';
            }
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.remove('active');
            pendingImportData = null;
        }
        window.closeImportModal = closeImportModal;

        async function confirmImport() {
            if (!pendingImportData || !currentUser) return;
            
            showSyncStatus('syncing', 'Importing...');
            
            try {
                if (pendingImportData.type === 'recipe') {
                    // Import single recipe
                    const newId = generateId();
                    await setDoc(doc(db, "users", currentUser.uid, "recipes", newId), {
                        name: pendingImportData.data.name,
                        ingredients: pendingImportData.data.ingredients || [],
                        titleOnly: pendingImportData.data.titleOnly || false,
                        notes: pendingImportData.data.notes || ''
                    });
                    
                    showSyncStatus('success', 'Recipe imported!');
                    closeImportModal();
                    
                    // Switch to recipes view
                    showView('recipes');
                    
                } else if (pendingImportData.type === 'recipes_bulk') {
                    // Import multiple recipes
                    const recipesToImport = pendingImportData.data.recipes || [];
                    
                    for (const recipe of recipesToImport) {
                        const newId = generateId();
                        await setDoc(doc(db, "users", currentUser.uid, "recipes", newId), {
                            name: recipe.name,
                            ingredients: recipe.ingredients || [],
                            titleOnly: recipe.titleOnly || false,
                            notes: recipe.notes || ''
                        });
                    }
                    
                    showSyncStatus('success', `${recipesToImport.length} recipes imported!`);
                    closeImportModal();
                    
                    // Switch to recipes view
                    showView('recipes');
                    
                } else if (pendingImportData.type === 'shop') {
                    // Import shop
                    const newShopId = generateId();
                    await setDoc(doc(db, "users", currentUser.uid, "shops", newShopId), {
                        name: pendingImportData.data.name,
                        aisles: pendingImportData.data.aisles || [],
                        isDefault: shops.length === 0 // Make default if first shop
                    });
                    
                    // Import ingredient mappings
                    const mappings = pendingImportData.data.ingredientMappings || {};
                    if (Object.keys(mappings).length > 0) {
                        // Merge with existing ingredient aisles
                        const updatedAisles = { ...ingredientAisles };
                        
                        Object.keys(mappings).forEach(ingredient => {
                            if (!updatedAisles[ingredient]) {
                                updatedAisles[ingredient] = {};
                            }
                            updatedAisles[ingredient][newShopId] = mappings[ingredient];
                        });
                        
                        await setDoc(doc(db, "users", currentUser.uid, "settings", "ingredientAisles"), updatedAisles);
                    }
                    
                    showSyncStatus('success', 'Shop layout imported!');
                    closeImportModal();
                    
                    // Switch to settings view
                    showView('settings');
                }
                
            } catch (error) {
                console.error("Error importing:", error);
                showSyncStatus('error', 'Import failed');
            }
        }
        window.confirmImport = confirmImport;

        // =====================
        // Ingredient Manager
        // =====================

        let editingIngredientName = null;

        function getIngredientUsage() {
            // Returns { ingredientName: [recipeNames] }
            const usage = {};
            
            recipes.forEach(recipe => {
                if (recipe.ingredients) {
                    recipe.ingredients.forEach(ing => {
                        let name;
                        if (typeof ing === 'string') {
                            name = ing.toLowerCase().trim();
                        } else if (ing && ing.name) {
                            name = ing.name.toLowerCase().trim();
                        } else {
                            return;
                        }
                        
                        if (!usage[name]) usage[name] = [];
                        if (!usage[name].includes(recipe.name)) {
                            usage[name].push(recipe.name);
                        }
                    });
                }
            });
            
            return usage;
        }

        function renderIngredientManager() {
            const list = document.getElementById('ingredient-manager-list');
            const empty = document.getElementById('ingredient-manager-empty');
            const search = document.getElementById('ingredient-manager-search');
            
            if (!list) return;
            
            const usage = getIngredientUsage();
            let ingredientNames = Object.keys(usage).sort();
            
            // Apply search filter
            const searchTerm = search?.value?.toLowerCase() || '';
            if (searchTerm) {
                ingredientNames = ingredientNames.filter(name => name.includes(searchTerm));
            }
            
            if (ingredientNames.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            list.innerHTML = ingredientNames.map(name => {
                const recipeCount = usage[name].length;
                const escapedName = escapeHtml(name).replace(/'/g, "\\'");
                
                return `
                    <div class="ingredient-manager-item">
                        <span class="ingredient-manager-name">${escapeHtml(name)}</span>
                        <span class="ingredient-manager-count">${recipeCount} recipe${recipeCount !== 1 ? 's' : ''}</span>
                        <div class="ingredient-manager-actions">
                            <button class="ingredient-manager-btn" onclick="openEditIngredientModal('${escapedName}')">Edit</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        window.renderIngredientManager = renderIngredientManager;

        function openEditIngredientModal(ingredientName) {
            editingIngredientName = ingredientName;
            
            const usage = getIngredientUsage();
            const recipeNames = usage[ingredientName] || [];
            
            document.getElementById('edit-ingredient-original').value = ingredientName;
            document.getElementById('edit-ingredient-name').value = ingredientName;
            document.getElementById('edit-ingredient-recipes').innerHTML = recipeNames.length > 0 
                ? recipeNames.map(r => escapeHtml(r)).join('<br>') 
                : '<em>Not used in any recipes</em>';
            
            // Populate merge dropdown with other ingredients
            const allIngredients = Object.keys(usage).filter(n => n !== ingredientName).sort();
            document.getElementById('edit-ingredient-merge').innerHTML = '<option value="">Don\'t merge</option>' +
                allIngredients.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
            
            document.getElementById('edit-ingredient-modal').classList.add('active');
        }
        window.openEditIngredientModal = openEditIngredientModal;

        function closeEditIngredientModal() {
            document.getElementById('edit-ingredient-modal').classList.remove('active');
            editingIngredientName = null;
        }
        window.closeEditIngredientModal = closeEditIngredientModal;

        async function saveIngredientEdit() {
            const originalName = document.getElementById('edit-ingredient-original').value;
            const newName = document.getElementById('edit-ingredient-name').value.trim().toLowerCase();
            const mergeWith = document.getElementById('edit-ingredient-merge').value;
            
            if (!newName && !mergeWith) {
                alert('Please enter a name or select an ingredient to merge with.');
                return;
            }
            
            const targetName = mergeWith || newName;
            
            if (targetName === originalName && !mergeWith) {
                closeEditIngredientModal();
                return; // No change
            }
            
            showSyncStatus('syncing', 'Updating recipes...');
            
            try {
                // Update all recipes that use this ingredient
                for (const recipe of recipes) {
                    if (!recipe.ingredients) continue;
                    
                    let changed = false;
                    const updatedIngredients = recipe.ingredients.map(ing => {
                        let name;
                        if (typeof ing === 'string') {
                            name = ing.toLowerCase().trim();
                            if (name === originalName) {
                                changed = true;
                                return { name: targetName, quantity: '' };
                            }
                            return { name: ing, quantity: '' }; // Migrate to new format
                        } else if (ing && ing.name) {
                            name = ing.name.toLowerCase().trim();
                            if (name === originalName) {
                                changed = true;
                                return { ...ing, name: targetName };
                            }
                            return ing;
                        }
                        return ing;
                    });
                    
                    if (changed) {
                        await setDoc(doc(db, "users", currentUser.uid, "recipes", recipe.id), {
                            ...recipe,
                            ingredients: updatedIngredients
                        });
                    }
                }
                
                // Update ingredient aisles if renamed (not merged)
                if (!mergeWith && newName !== originalName && ingredientAisles[originalName]) {
                    ingredientAisles[newName] = ingredientAisles[originalName];
                    delete ingredientAisles[originalName];
                    await setDoc(doc(db, "users", currentUser.uid, "settings", "ingredientAisles"), ingredientAisles);
                }
                
                // If merging, remove the old ingredient's aisle data
                if (mergeWith && ingredientAisles[originalName]) {
                    delete ingredientAisles[originalName];
                    await setDoc(doc(db, "users", currentUser.uid, "settings", "ingredientAisles"), ingredientAisles);
                }
                
                showSyncStatus('success', 'Updated!');
                closeEditIngredientModal();
                renderIngredientManager();
                renderIngredientDictionary();
                
            } catch (error) {
                console.error("Error updating ingredient:", error);
                showSyncStatus('error', 'Update failed');
            }
        }
        window.saveIngredientEdit = saveIngredientEdit;

        async function deleteIngredient() {
            const originalName = document.getElementById('edit-ingredient-original').value;
            
            if (!confirm(`Delete "${originalName}" from all recipes? This cannot be undone.`)) {
                return;
            }
            
            showSyncStatus('syncing', 'Deleting...');
            
            try {
                // Remove from all recipes
                for (const recipe of recipes) {
                    if (!recipe.ingredients) continue;
                    
                    const originalLength = recipe.ingredients.length;
                    const updatedIngredients = recipe.ingredients.filter(ing => {
                        let name;
                        if (typeof ing === 'string') {
                            name = ing.toLowerCase().trim();
                        } else if (ing && ing.name) {
                            name = ing.name.toLowerCase().trim();
                        } else {
                            return true;
                        }
                        return name !== originalName;
                    });
                    
                    if (updatedIngredients.length !== originalLength) {
                        await setDoc(doc(db, "users", currentUser.uid, "recipes", recipe.id), {
                            ...recipe,
                            ingredients: updatedIngredients
                        });
                    }
                }
                
                // Remove from ingredient aisles
                if (ingredientAisles[originalName]) {
                    delete ingredientAisles[originalName];
                    await setDoc(doc(db, "users", currentUser.uid, "settings", "ingredientAisles"), ingredientAisles);
                }
                
                showSyncStatus('success', 'Deleted!');
                closeEditIngredientModal();
                renderIngredientManager();
                renderIngredientDictionary();
                
            } catch (error) {
                console.error("Error deleting ingredient:", error);
                showSyncStatus('error', 'Delete failed');
            }
        }
        window.deleteIngredient = deleteIngredient;

        // =====================
        // Day Notes Functions
        // =====================

        function toggleDayNotes(dateStr) {
            const editor = document.getElementById(`notes-editor-${dateStr}`);
            const input = document.getElementById(`notes-input-${dateStr}`);
            
            if (editor.style.display === 'none') {
                editor.style.display = 'block';
                input.focus();
            } else {
                editor.style.display = 'none';
            }
        }
        window.toggleDayNotes = toggleDayNotes;

        async function saveDayNote(dateStr) {
            const input = document.getElementById(`notes-input-${dateStr}`);
            const note = input.value.trim();
            
            if (note) {
                dayNotes[dateStr] = note;
            } else {
                delete dayNotes[dateStr];
            }
            
            await saveUserPrefs();
        }
        window.saveDayNote = saveDayNote;

        async function saveUserPrefs() {
            if (!currentUser) return;
            
            try {
                await setDoc(doc(db, "users", currentUser.uid, "settings", "userPrefs"), {
                    mealCategories: mealCategories,
                    dayNotes: dayNotes
                });
            } catch (error) {
                console.error("Error saving user prefs:", error);
            }
        }

        // =====================
        // Meal Categories Functions
        // =====================

        function renderMealCategories() {
            const container = document.getElementById('meal-categories-list');
            if (!container) return;
            
            container.innerHTML = mealCategories.map((category, index) => `
                <div class="meal-category-item">
                    <input type="text" class="meal-category-input" value="${escapeHtml(category)}" 
                           onchange="updateMealCategory(${index}, this.value)" 
                           placeholder="Category name">
                    <button class="meal-category-btn move" onclick="moveMealCategory(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="Move up">‚ñ≤</button>
                    <button class="meal-category-btn move" onclick="moveMealCategory(${index}, 1)" ${index === mealCategories.length - 1 ? 'disabled' : ''} title="Move down">‚ñº</button>
                    <button class="meal-category-btn" onclick="deleteMealCategory(${index})" title="Delete">‚úï</button>
                </div>
            `).join('');
        }
        window.renderMealCategories = renderMealCategories;

        async function addMealCategory() {
            const input = document.getElementById('new-meal-category');
            const name = input.value.trim();
            
            if (!name) return;
            
            mealCategories.push(name);
            input.value = '';
            
            await saveUserPrefs();
            renderMealCategories();
            renderPlanner();
        }
        window.addMealCategory = addMealCategory;

        async function updateMealCategory(index, newName) {
            if (!newName.trim()) return;
            mealCategories[index] = newName.trim();
            await saveUserPrefs();
            renderPlanner();
        }
        window.updateMealCategory = updateMealCategory;

        async function moveMealCategory(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= mealCategories.length) return;
            
            [mealCategories[index], mealCategories[newIndex]] = [mealCategories[newIndex], mealCategories[index]];
            
            await saveUserPrefs();
            renderMealCategories();
            renderPlanner();
        }
        window.moveMealCategory = moveMealCategory;

        async function deleteMealCategory(index) {
            if (mealCategories.length <= 1) {
                alert('You must have at least one meal category.');
                return;
            }
            
            if (!confirm(`Delete "${mealCategories[index]}"? Meals planned in this category will remain but may not display correctly.`)) {
                return;
            }
            
            mealCategories.splice(index, 1);
            await saveUserPrefs();
            renderMealCategories();
            renderPlanner();
        }
        window.deleteMealCategory = deleteMealCategory;

        // =====================
        // Ad-hoc Item Autocomplete
        // =====================

        function setupAdhocAutocomplete() {
            const input = document.getElementById('add-item-input');
            if (!input) return;
            
            // Remove existing listener if any
            input.removeEventListener('input', handleAdhocInput);
            input.addEventListener('input', handleAdhocInput);
            
            input.removeEventListener('keydown', handleAdhocKeydown);
            input.addEventListener('keydown', handleAdhocKeydown);
            
            input.removeEventListener('blur', hideAdhocAutocomplete);
            input.addEventListener('blur', () => setTimeout(hideAdhocAutocomplete, 150));
        }

        let adhocAutocompleteIndex = -1;

        function handleAdhocInput(e) {
            const value = e.target.value.toLowerCase().trim();
            
            // Remove existing dropdown
            const existing = document.getElementById('adhoc-autocomplete');
            if (existing) existing.remove();
            
            if (value.length < 2) return;
            
            const allNames = getAllIngredientNames();
            const matches = allNames.filter(name => 
                name.includes(value) && name !== value
            ).slice(0, 6);
            
            if (matches.length === 0) return;
            
            const dropdown = document.createElement('div');
            dropdown.id = 'adhoc-autocomplete';
            dropdown.className = 'autocomplete-dropdown';
            dropdown.style.position = 'absolute';
            dropdown.style.width = '100%';
            dropdown.style.top = '100%';
            dropdown.style.left = '0';
            
            matches.forEach((name, index) => {
                const aisle = getIngredientAisle(name, currentShopId);
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `${escapeHtml(name)}${aisle ? `<span class="autocomplete-aisle">(${escapeHtml(aisle)})</span>` : ''}`;
                item.onmousedown = (ev) => {
                    ev.preventDefault();
                    selectAdhocAutocomplete(name);
                };
                dropdown.appendChild(item);
            });
            
            const wrapper = e.target.parentElement;
            wrapper.style.position = 'relative';
            wrapper.appendChild(dropdown);
            adhocAutocompleteIndex = -1;
        }

        function handleAdhocKeydown(e) {
            const dropdown = document.getElementById('adhoc-autocomplete');
            if (!dropdown) return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                adhocAutocompleteIndex = Math.min(adhocAutocompleteIndex + 1, items.length - 1);
                updateAdhocAutocompleteHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                adhocAutocompleteIndex = Math.max(adhocAutocompleteIndex - 1, -1);
                updateAdhocAutocompleteHighlight(items);
            } else if (e.key === 'Enter' && adhocAutocompleteIndex >= 0) {
                e.preventDefault();
                const selectedItem = items[adhocAutocompleteIndex];
                if (selectedItem) {
                    const name = selectedItem.textContent.split('(')[0].trim();
                    selectAdhocAutocomplete(name);
                }
            } else if (e.key === 'Escape') {
                dropdown.remove();
            }
        }

        function updateAdhocAutocompleteHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === adhocAutocompleteIndex);
            });
        }

        function selectAdhocAutocomplete(name) {
            const input = document.getElementById('add-item-input');
            input.value = name;
            hideAdhocAutocomplete();
        }

        function hideAdhocAutocomplete() {
            const dropdown = document.getElementById('adhoc-autocomplete');
            if (dropdown) dropdown.remove();
        }

        // =====================
        // Bulk Recipe Sharing
        // =====================

        async function shareBulkRecipes() {
            if (!currentUser || recipes.length === 0) {
                alert('No recipes to share.');
                return;
            }
            
            // Show selection modal
            const selectedRecipes = [];
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            recipes.forEach(recipe => {
                html += `
                    <label class="form-checkbox" style="display: block; padding: 0.5rem; border-bottom: 1px solid var(--border-light);">
                        <input type="checkbox" value="${recipe.id}" class="bulk-share-checkbox">
                        <span>${escapeHtml(recipe.name)}</span>
                    </label>
                `;
            });
            html += '</div>';
            html += '<p class="form-hint mt-1">Select the recipes you want to share.</p>';
            
            document.getElementById('bulk-share-list').innerHTML = html;
            document.getElementById('bulk-share-modal').classList.add('active');
        }
        window.shareBulkRecipes = shareBulkRecipes;

        function closeBulkShareModal() {
            document.getElementById('bulk-share-modal').classList.remove('active');
        }
        window.closeBulkShareModal = closeBulkShareModal;

        async function confirmBulkShare() {
            const checkboxes = document.querySelectorAll('.bulk-share-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                alert('Please select at least one recipe to share.');
                return;
            }
            
            showSyncStatus('syncing', 'Creating share link...');
            
            try {
                const shareId = generateShareId();
                
                // Get selected recipes
                const recipesToShare = recipes
                    .filter(r => selectedIds.includes(r.id))
                    .map(r => ({
                        name: r.name,
                        ingredients: r.ingredients || [],
                        titleOnly: r.titleOnly || false,
                        notes: r.notes || ''
                    }));
                
                // Store in shared collection
                await setDoc(doc(db, "shared", shareId), {
                    type: 'recipes_bulk',
                    data: {
                        recipes: recipesToShare,
                        count: recipesToShare.length
                    },
                    sharedBy: currentUser.uid,
                    sharedAt: new Date().toISOString()
                });
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?import=${shareId}`;
                
                closeBulkShareModal();
                showShareModal(`Share ${recipesToShare.length} Recipes`, shareUrl);
                showSyncStatus('success', 'Link created!');
            } catch (error) {
                console.error("Error sharing recipes:", error);
                showSyncStatus('error', 'Share failed');
            }
        }
        window.confirmBulkShare = confirmBulkShare;

        // =====================
        // Welcome Modal
        // =====================

        function openWelcomeModal() {
            document.getElementById('welcome-modal').classList.add('active');
        }
        window.openWelcomeModal = openWelcomeModal;

        function closeWelcomeModal(dontShowAgain = false) {
            document.getElementById('welcome-modal').classList.remove('active');
            
            if (dontShowAgain && currentUser) {
                // Save preference to not show again
                localStorage.setItem(`welcomeShown_${currentUser.uid}`, 'true');
            }
        }
        window.closeWelcomeModal = closeWelcomeModal;

        function checkShowWelcome() {
            if (!currentUser) return;
            
            const welcomeShown = localStorage.getItem(`welcomeShown_${currentUser.uid}`);
            if (!welcomeShown) {
                // Small delay to let the app load first
                setTimeout(() => {
                    openWelcomeModal();
                }, 500);
            }
        }

        // =====================
        // Help Modal
        // =====================

        function openHelpModal() {
            document.getElementById('help-modal').classList.add('active');
        }
        window.openHelpModal = openHelpModal;

        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('active');
        }
        window.closeHelpModal = closeHelpModal;

        function toggleHelpItem(element) {
            const item = element.closest('.help-item');
            item.classList.toggle('open');
        }
        window.toggleHelpItem = toggleHelpItem;

        // =====================
        // PWA Install Prompt
        // =====================

        let deferredPrompt = null;

        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            // Don't show if already dismissed
            if (localStorage.getItem('installPromptDismissed')) return;
            
            // Create and show the install prompt
            const existingPrompt = document.getElementById('install-prompt');
            if (existingPrompt) return;
            
            const prompt = document.createElement('div');
            prompt.id = 'install-prompt';
            prompt.className = 'install-prompt';
            prompt.innerHTML = `
                <div class="install-prompt-icon">üì±</div>
                <div class="install-prompt-text">
                    <h4>Install KitchenListr</h4>
                    <p>Add to your home screen for quick access</p>
                </div>
                <div class="install-prompt-actions">
                    <button class="btn btn-primary btn-small" onclick="installApp()">Install</button>
                    <button class="install-prompt-close" onclick="dismissInstallPrompt()">&times;</button>
                </div>
            `;
            document.body.appendChild(prompt);
        }

        function installApp() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted install prompt');
                }
                deferredPrompt = null;
                hideInstallPrompt();
            });
        }
        window.installApp = installApp;

        function dismissInstallPrompt() {
            localStorage.setItem('installPromptDismissed', 'true');
            hideInstallPrompt();
        }
        window.dismissInstallPrompt = dismissInstallPrompt;

        function hideInstallPrompt() {
            const prompt = document.getElementById('install-prompt');
            if (prompt) prompt.remove();
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // =====================
        // Initialize
        // =====================

        initDateRangePicker();
        renderPlanner();
    </script>
</body>
</html>
